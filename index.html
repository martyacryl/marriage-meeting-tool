<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Marriage Meeting Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lucide { width: 1em; height: 1em; display: inline-block; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Simple icon components
        const ChevronLeft = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>;
        const ChevronRight = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>;
        const Calendar = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>;
        const CheckSquare = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const Heart = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>;
        const Target = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg>;
        const ShoppingCart = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.293 2.293c-.63.63-.184 1.707.707 1.707H19M17 21a2 2 0 100-4 2 2 0 000 4zM9 21a2 2 0 100-4 2 2 0 000 4z" /></svg>;
        const Plus = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const X = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
        const Check = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>;
        const UserX = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;
        const Wifi = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" /></svg>;
        const WifiOff = ({ className }) => <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M1 1l22 22M16.72 11.06A10.94 10.94 0 0119 12.55M5 12.55a10.94 10.94 0 015.17-2.39M10.71 5.05A16 16 0 0122.58 9M1.42 9a15.91 15.91 0 014.7-2.88M8.53 16.11a6 6 0 016.95 0M12 20h.01" /></svg>;

        const { useState, useEffect, useCallback, useRef } = React;

        // Initialize Supabase
        const supabaseUrl = 'https://jrutqdesurnansyfydbf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpydXRxZGVzdXJuYW5zeWZ5ZGJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NTA4MzgsImV4cCI6MjA3MTEyNjgzOH0.G-sTw0eF-tQEcqvbaz-hSM2h0KVr2NMOYMq4x0iwIIc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const MarriageMeetingTool = () => {
            const [currentWeek, setCurrentWeek] = useState(new Date());
            const [weekData, setWeekData] = useState({});
            const [isConnected, setIsConnected] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [lastSaved, setLastSaved] = useState(null);
            const saveTimeoutRef = useRef(null);

            // Debounced save function - waits 1 second after you stop typing
            const debouncedSave = useCallback(async (weekKey, data) => {
                // Clear any existing timeout
                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }

                // Set a new timeout
                saveTimeoutRef.current = setTimeout(async () => {
                    console.log('Saving after debounce...');
                    await saveWeekData(weekKey, data);
                }, 1000); // Wait 1 second after user stops typing
            }, []);

            // Clean up timeout on unmount
            useEffect(() => {
                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, []);

            // Get Monday of current week
            const getMonday = (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            };

            const formatWeekKey = (date) => {
                const monday = getMonday(date);
                return monday.toISOString().split('T')[0];
            };

            const formatWeekDisplay = (date) => {
                const monday = getMonday(date);
                const sunday = new Date(monday);
                sunday.setDate(sunday.getDate() + 6);
                
                return `${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            };

            // Initialize database table
            const initializeDatabase = async () => {
                try {
                    // Create table if it doesn't exist
                    const { error } = await supabase.rpc('create_marriage_meeting_table');
                    if (error && !error.message.includes('already exists')) {
                        console.log('Table might already exist, continuing...');
                    }
                    setIsConnected(true);
                } catch (error) {
                    console.log('Database setup info:', error);
                    setIsConnected(true); // Continue anyway
                }
            };

            // Load week data from database
            const loadWeekData = async (weekKey) => {
                try {
                    console.log('Loading data for week:', weekKey);
                    const { data, error } = await supabase
                        .from('marriage_meetings')
                        .select('*')
                        .eq('week_key', weekKey);

                    console.log('Database response:', { data, error });

                    if (error) {
                        console.log('Error loading:', error);
                        return null;
                    }

                    if (data && data.length > 0) {
                        console.log('Found existing data:', data[0].data);
                        return data[0].data;
                    }

                    console.log('No existing data found for this week');
                    return null;
                } catch (error) {
                    console.log('Load error:', error);
                    return null;
                }
            };

            // Save week data to database
            const saveWeekData = async (weekKey, data) => {
                try {
                    console.log('Saving data for week:', weekKey);
                    console.log('Data to save:', data);
                    
                    // Use upsert with explicit conflict resolution
                    const { data: result, error } = await supabase
                        .from('marriage_meetings')
                        .upsert({
                            week_key: weekKey,
                            data: data
                        }, {
                            onConflict: 'week_key'
                        })
                        .select();

                    if (error) {
                        console.log('Upsert error:', error);
                        return false;
                    }

                    console.log('Data saved successfully:', result);
                    setLastSaved(new Date());
                    return true;
                } catch (error) {
                    console.log('Save error:', error);
                    return false;
                }
            };

            // Initialize week data if it doesn't exist
            const initializeWeekData = useCallback(async () => {
                const weekKey = formatWeekKey(currentWeek);
                
                // Check if we already have this week's data
                if (weekData[weekKey]) {
                    return weekData[weekKey];
                }

                setIsLoading(true);
                
                // Try to load from database
                const savedData = await loadWeekData(weekKey);
                
                if (savedData) {
                    setWeekData(prev => ({ ...prev, [weekKey]: savedData }));
                    setIsLoading(false);
                    return savedData;
                }

                // Create new week data
                const newWeekData = {
                    schedule: {
                        Monday: [''],
                        Tuesday: [''],
                        Wednesday: [''],
                        Thursday: [''],
                        Friday: [''],
                        Saturday: [''],
                        Sunday: ['']
                    },
                    todos: [],
                    prayers: [],
                    goals: [],
                    grocery: [],
                    unconfessedSin: []
                };

                setWeekData(prev => ({ ...prev, [weekKey]: newWeekData }));
                await saveWeekData(weekKey, newWeekData);
                setIsLoading(false);
                return newWeekData;
            }, [currentWeek, weekData]);

            // Initialize on component mount
            useEffect(() => {
                initializeDatabase().then(() => {
                    initializeWeekData();
                });
            }, [initializeWeekData]);

            // Set up real-time subscription
            useEffect(() => {
                const channel = supabase
                    .channel('marriage_meetings')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'marriage_meetings' }, 
                        (payload) => {
                            if (payload.new && payload.new.week_key) {
                                setWeekData(prev => ({
                                    ...prev,
                                    [payload.new.week_key]: payload.new.data
                                }));
                            }
                        }
                    )
                    .subscribe();

                return () => {
                    channel.unsubscribe();
                };
            }, []);

            const currentWeekData = weekData[formatWeekKey(currentWeek)] || {
                schedule: {
                    Monday: [''], Tuesday: [''], Wednesday: [''], Thursday: [''],
                    Friday: [''], Saturday: [''], Sunday: ['']
                },
                todos: [], prayers: [], goals: [], grocery: [], unconfessedSin: []
            };

            // Update functions with debounced auto-save
            const updateSchedule = (day, index, value) => {
                const weekKey = formatWeekKey(currentWeek);
                const newData = {
                    ...currentWeekData,
                    schedule: {
                        ...currentWeekData.schedule,
                        [day]: currentWeekData.schedule[day].map((item, i) => i === index ? value : item)
                    }
                };
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                debouncedSave(weekKey, newData); // Debounced save
            };

            const addScheduleLine = async (day) => {
                const weekKey = formatWeekKey(currentWeek);
                const newData = {
                    ...currentWeekData,
                    schedule: {
                        ...currentWeekData.schedule,
                        [day]: [...currentWeekData.schedule[day], '']
                    }
                };
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                await saveWeekData(weekKey, newData); // Immediate save for structure changes
            };

            const removeScheduleLine = async (day, index) => {
                const weekKey = formatWeekKey(currentWeek);
                const newData = {
                    ...currentWeekData,
                    schedule: {
                        ...currentWeekData.schedule,
                        [day]: currentWeekData.schedule[day].filter((_, i) => i !== index)
                    }
                };
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                await saveWeekData(weekKey, newData); // Immediate save for structure changes
            };

            const updateList = async (listType, items) => {
                const weekKey = formatWeekKey(currentWeek);
                const newData = {
                    ...currentWeekData,
                    [listType]: items
                };
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                debouncedSave(weekKey, newData); // Debounced save
            };

            const addListItem = (listType, text = '') => {
                const weekKey = formatWeekKey(currentWeek);
                const currentItems = currentWeekData[listType] || [];
                const newItem = { id: Date.now(), text, completed: false };
                const newData = {
                    ...currentWeekData,
                    [listType]: [...currentItems, newItem]
                };
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                saveWeekData(weekKey, newData); // Immediate save for new items
            };

            const toggleListItem = (listType, id) => {
                const weekKey = formatWeekKey(currentWeek);
                const currentItems = currentWeekData[listType] || [];
                const updatedItems = currentItems.map(item => 
                    item.id === id ? { ...item, completed: !item.completed } : item
                );
                const newData = {
                    ...currentWeekData,
                    [listType]: updatedItems
                };
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                saveWeekData(weekKey, newData); // Immediate save for toggles
            };

            const removeListItem = (listType, id) => {
                const weekKey = formatWeekKey(currentWeek);
                const currentItems = currentWeekData[listType] || [];
                const updatedItems = currentItems.filter(item => item.id !== id);
                const newData = {
                    ...currentWeekData,
                    [listType]: updatedItems
                };
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                saveWeekData(weekKey, newData); // Immediate save for deletions
            };

            const navigateWeek = (direction) => {
                const newDate = new Date(currentWeek);
                newDate.setDate(newDate.getDate() + (direction * 7));
                setCurrentWeek(newDate);
            };

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            const ListSection = ({ title, listType, icon: Icon, placeholder }) => {
                const items = currentWeekData[listType] || [];
                
                return (
                    <div className="bg-white rounded-lg border p-4">
                        <div className="flex items-center gap-2 mb-3">
                            <Icon className="w-5 h-5 text-blue-600" />
                            <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
                            <button
                                onClick={() => addListItem(listType)}
                                className="ml-auto p-1 text-blue-600 hover:bg-blue-50 rounded"
                                disabled={isLoading}
                            >
                                <Plus className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="space-y-2">
                            {items.map((item) => (
                                <div key={item.id} className="flex items-center gap-2 group">
                                    <button
                                        onClick={() => toggleListItem(listType, item.id)}
                                        className={`p-1 rounded ${item.completed ? 'text-green-600' : 'text-gray-400'} hover:bg-gray-50`}
                                        disabled={isLoading}
                                    >
                                        <Check className="w-4 h-4" />
                                    </button>
                                    <input
                                        type="text"
                                        value={item.text}
                                        onChange={(e) => updateListItem(listType, item.id, e.target.value)}
                                        placeholder={placeholder}
                                        className={`flex-1 p-2 border rounded ${item.completed ? 'line-through text-gray-500 bg-gray-50' : ''}`}
                                        disabled={isLoading}
                                    />
                                    <button
                                        onClick={() => removeListItem(listType, item.id)}
                                        className="opacity-0 group-hover:opacity-100 p-1 text-red-500 hover:bg-red-50 rounded"
                                        disabled={isLoading}
                                    >
                                        <X className="w-4 h-4" />
                                    </button>
                                </div>
                            ))}
                            {items.length === 0 && (
                                <p className="text-gray-500 text-center py-4">No items yet. Click + to add one!</p>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-7xl mx-auto p-6 bg-gray-50 min-h-screen">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow-sm border p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <Calendar className="w-8 h-8 text-blue-600" />
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-800">Weekly Marriage Meeting</h1>
                                    <p className="text-gray-600">Planning and connecting together</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 text-sm">
                                    {isConnected ? (
                                        <div className="flex items-center gap-1 text-green-600">
                                            <Wifi className="w-4 h-4" />
                                            <span>Synced</span>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-1 text-red-500">
                                            <WifiOff className="w-4 h-4" />
                                            <span>Offline</span>
                                        </div>
                                    )}
                                    {lastSaved && (
                                        <span className="text-gray-500">
                                            • Saved {lastSaved.toLocaleTimeString()}
                                        </span>
                                    )}
                                </div>
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => navigateWeek(-1)}
                                        className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                        disabled={isLoading}
                                    >
                                        <ChevronLeft />
                                    </button>
                                    <span className="text-lg font-semibold text-gray-800 px-4">
                                        {formatWeekDisplay(currentWeek)}
                                    </span>
                                    <button
                                        onClick={() => navigateWeek(1)}
                                        className="p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                        disabled={isLoading}
                                    >
                                        <ChevronRight />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {isLoading && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <p className="text-blue-800">Loading week data...</p>
                        </div>
                    )}

                    {/* Schedule Section */}
                    <div className="bg-white rounded-lg border p-6 mb-6">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">Weekly Schedule</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {days.map((day) => (
                                <div key={day} className="border rounded-lg p-3">
                                    <h3 className="font-semibold text-gray-700 mb-2">{day}</h3>
                                    <div className="space-y-1">
                                        {(currentWeekData.schedule?.[day] || ['']).map((item, index) => (
                                            <div key={index} className="flex items-center gap-1">
                                                <textarea
                                                    value={item}
                                                    onChange={(e) => updateSchedule(day, index, e.target.value)}
                                                    placeholder="Add commitment or note..."
                                                    className="flex-1 p-2 text-sm border rounded resize-none overflow-hidden"
                                                    rows={1}
                                                    style={{
                                                        minHeight: '36px',
                                                        height: 'auto'
                                                    }}
                                                    onInput={(e) => {
                                                        e.target.style.height = 'auto';
                                                        e.target.style.height = e.target.scrollHeight + 'px';
                                                    }}
                                                    disabled={isLoading}
                                                />
                                                {(currentWeekData.schedule?.[day] || []).length > 1 && (
                                                    <button
                                                        onClick={() => removeScheduleLine(day, index)}
                                                        className="p-1 text-red-500 hover:bg-red-50 rounded"
                                                        disabled={isLoading}
                                                    >
                                                        <X className="w-3 h-3" />
                                                    </button>
                                                )}
                                            </div>
                                        ))}
                                        <button
                                            onClick={() => addScheduleLine(day)}
                                            className="w-full p-2 text-blue-600 hover:bg-blue-50 rounded border border-dashed border-blue-300 text-sm"
                                            disabled={isLoading}
                                        >
                                            <Plus className="w-3 h-3 inline mr-1" />
                                            Add line
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Lists Section */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <ListSection
                            title="To-Do List"
                            listType="todos"
                            icon={CheckSquare}
                            placeholder="Enter a task..."
                        />
                        <ListSection
                            title="Prayer List"
                            listType="prayers"
                            icon={Heart}
                            placeholder="Enter a prayer request..."
                        />
                        <ListSection
                            title="Goals"
                            listType="goals"
                            icon={Target}
                            placeholder="Enter a goal..."
                        />
                        <ListSection
                            title="Grocery List"
                            listType="grocery"
                            icon={ShoppingCart}
                            placeholder="Enter grocery item..."
                        />
                        <ListSection
                            title="Unconfessed Sin"
                            listType="unconfessedSin"
                            icon={UserX}
                            placeholder="Enter area to confess..."
                        />
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MarriageMeetingTool />, document.getElementById('root'));
    </script>
</body>
</html>
