<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Marriage Meeting Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#06b6d4',
                    }
                }
            }
        }
    </script>
    <style>
        .section-divider {
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
            height: 1px;
            margin: 1.5rem 0;
        }
        .section-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 16px;
        }
        .section-header {
            background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        .status-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .modern-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // Initialize Supabase - PRODUCTION ENVIRONMENT with Auth
        const supabaseUrl = 'https://jrutqdesurnansyfydbf.supabase.co';
        // Choose your key type:
        // - anon key: Safe for users, limited admin functions (RECOMMENDED for production)
        // - service_role key: Full admin access (get from Supabase Dashboard ‚Üí Settings ‚Üí API)
        const USE_SERVICE_ROLE_KEY = false; // Set to false to use proper RLS policies
        const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpydXRxZGVzdXJuYW5zeWZ5ZGJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NTA4MzgsImV4cCI6MjA3MTEyNjgzOH0.G-sTw0eF-tQEcqvbaz-hSM2h0KVr2NMOYMq4x0iwIIc';
        // Add your service role key here (get from Supabase Dashboard ‚Üí Settings ‚Üí API)
        const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpydXRxZGVzdXJuYW5zeWZ5ZGJmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTU1MDgzOCwiZXhwIjoyMDcxMTI2ODM4fQ.DZFYORSXw99L7SmqoB-KHGf-F4RpTO99PC2wLCA1RBA';
        
        // Use anon key for regular users, service role key only for admin functions
        const supabaseKey = USE_SERVICE_ROLE_KEY ? serviceRoleKey : anonKey;
        
        // Initialize Supabase clients with better loading detection
        // Make these truly global so React component can access them
        window.supabase = null;
        window.adminSupabase = null;
        let supabase = window.supabase;
        let adminSupabase = window.adminSupabase;
        
        function initializeSupabaseClients() {
            console.log('üîç initializeSupabaseClients called');
            console.log('üîç Current state:', {
                'window.supabase': window.supabase,
                'window.Supabase': window.Supabase,
                'window.supabaseClient': window.supabaseClient,
                'window.supabase type': typeof window.supabase,
                'window.Supabase type': typeof window.Supabase,
                'window.supabaseClient type': typeof window.supabaseClient
            });
            
            // Check multiple possible ways Supabase might be available
            let supabaseModule = null;
            
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                supabaseModule = window.supabase;
                console.log('‚úÖ Found window.supabase.createClient');
            } else if (window.Supabase && typeof window.Supabase.createClient === 'function') {
                supabaseModule = window.Supabase;
                console.log('‚úÖ Found window.Supabase.createClient');
            } else if (window.supabaseClient && typeof window.supabaseClient.createClient === 'function') {
                supabaseModule = window.supabaseClient;
                console.log('‚úÖ Found window.supabaseClient.createClient');
            } else {
                // Try to find any Supabase-related global
                const supabaseKeys = Object.keys(window).filter(key => 
                    key.toLowerCase().includes('supabase') && 
                    window[key] && 
                    typeof window[key].createClient === 'function'
                );
                if (supabaseKeys.length > 0) {
                    supabaseModule = window[supabaseKeys[0]];
                    console.log('‚úÖ Found Supabase module via search:', supabaseKeys[0]);
                }
            }
            
            if (supabaseModule) {
                try {
                    // Create clients and assign to both local and global variables
                    supabase = supabaseModule.createClient(supabaseUrl, supabaseKey);
                    adminSupabase = supabaseModule.createClient(supabaseUrl, serviceRoleKey);
                    window.supabase = supabase;
                    window.adminSupabase = adminSupabase;
                    console.log('‚úÖ Supabase clients created successfully');
                    console.log('‚úÖ Global variables updated:', {
                        'window.supabase': !!window.supabase,
                        'window.adminSupabase': !!window.adminSupabase
                    });
                    // Notify that Supabase is ready
                    notifySupabaseReady();
                    return true;
                } catch (error) {
                    console.error('‚ùå Error creating Supabase clients:', error);
                    return false;
                }
            }
            
            console.log('‚ùå No Supabase module found. Available globals:', Object.keys(window).filter(key => key.toLowerCase().includes('supabase')));
            return false;
        }
        
        // Wait for DOM and scripts to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeSupabaseWithRetry();
        });
        
        // Also try on window load as backup
        window.addEventListener('load', () => {
            if (!supabase || !adminSupabase) {
                console.log('üîÑ Window loaded, trying Supabase initialization again...');
                initializeSupabaseWithRetry();
            }
        });
        
        // Global flag to track when Supabase is ready
        window.supabaseReady = false;
        
        // Function to notify that Supabase is ready
        function notifySupabaseReady() {
            window.supabaseReady = true;
            console.log('üéâ Supabase is ready! Notifying app...');
            // Dispatch a custom event to notify the React component
            window.dispatchEvent(new CustomEvent('supabaseReady'));
            
            // Also try to force a React re-render by updating a global variable
            if (window.forceReactUpdate) {
                window.forceReactUpdate();
            }
        }
        
        function initializeSupabaseWithRetry() {
            // Try to initialize immediately
            if (!initializeSupabaseClients()) {
                console.log('‚ö†Ô∏è Supabase library not ready, waiting for it to load...');
                
                // Wait for Supabase to be available
                const checkSupabase = setInterval(() => {
                    if (initializeSupabaseClients()) {
                        clearInterval(checkSupabase);
                        console.log('‚úÖ Supabase clients initialized after waiting');
                    }
                }, 100);
                
                // Fallback: if it takes too long, try dynamic loading
                setTimeout(() => {
                    if (!supabase || !adminSupabase) {
                        clearInterval(checkSupabase);
                        console.log('‚ö†Ô∏è Taking too long, loading Supabase dynamically...');
                        
                        console.log('üîÑ Trying multiple CDN sources for Supabase...');
                        
                        // Try multiple CDN sources
                        const cdnSources = [
                            'https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js',
                            'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js',
                            'https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js',
                            'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js'
                        ];
                        
                        let currentSourceIndex = 0;
                        
                        function tryNextSource() {
                            if (currentSourceIndex >= cdnSources.length) {
                                console.error('‚ùå All CDN sources failed. Trying to reload the page...');
                                // Last resort: reload the page to retry the original script tag
                                setTimeout(() => {
                                    console.log('üîÑ Reloading page as last resort...');
                                    window.location.reload();
                                }, 2000);
                                return;
                            }
                            
                            const script = document.createElement('script');
                            script.src = cdnSources[currentSourceIndex];
                            console.log(`üîÑ Trying CDN source ${currentSourceIndex + 1}: ${cdnSources[currentSourceIndex]}`);
                            
                            script.onload = () => {
                                console.log(`‚úÖ Supabase script loaded from: ${cdnSources[currentSourceIndex]}`);
                                console.log('üîç Checking what was loaded:', {
                                    'window.supabase': typeof window.supabase,
                                    'window.Supabase': typeof window.Supabase,
                                    'window.supabaseClient': typeof window.supabaseClient,
                                    'window.supabase.createClient': typeof window.supabase?.createClient,
                                    'window.Supabase.createClient': typeof window.Supabase?.createClient
                                });
                                setTimeout(() => {
                                    if (initializeSupabaseClients()) {
                                        console.log('‚úÖ Supabase clients created after dynamic load');
                                        // notifySupabaseReady is already called in initializeSupabaseClients
                                    } else {
                                        console.error('‚ùå Still failed to create clients after dynamic load');
                                        console.log('üö® Final check - available globals:', Object.keys(window).filter(key => key.toLowerCase().includes('supabase')));
                                    }
                                }, 1000);
                            };
                            
                            script.onerror = () => {
                                console.error(`‚ùå Failed to load from: ${cdnSources[currentSourceIndex]}`);
                                currentSourceIndex++;
                                tryNextSource();
                            };
                            
                            document.head.appendChild(script);
                        }
                        
                        tryNextSource();
                    }
                }, 5000); // Wait 5 seconds before trying dynamic loading
            }
        }

        // PRODUCTION TABLE NAME
        const TABLE_NAME = 'marriage_meetings';

        // Auth state
        let currentUser = null;
        let isAdmin = false;

        // Icons as SVG components
        const ChevronLeftIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
        );

        const ChevronRightIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
        );

        const PlusIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const CheckIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
        );

        const TrashIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        // Authentication Components
        const SignInScreen = ({ onSignIn, onAdminSignIn }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSignIn = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    
                    // Check if user is admin (you can set this in user metadata)
                    const isUserAdmin = data.user?.user_metadata?.is_admin === true;
                    if (isUserAdmin) {
                        onAdminSignIn(data.user);
                    } else {
                        onSignIn(data.user);
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-100 to-green-50">
                    <div className="modern-card p-8 w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-8 text-primary">
                            Weekly Marriage Meeting Tool
                        </h1>
                        <p className="text-center text-gray-600 mb-6">Sign in to access your marriage planning</p>
                        
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        
                        <form onSubmit={handleSignIn} className="space-y-4">
                            <input
                                type="email"
                                placeholder="Email"
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                            />
                            <input
                                type="password"
                                placeholder="Password"
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                            />
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </form>
                        
                        <div className="mt-6 text-center">
                            <p className="text-sm text-gray-500">
                                Contact your administrator for access
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ user, onSignOut, onAddUser, onRemoveUser, useServiceRoleKey }) => {
            const [users, setUsers] = useState([]);
            const [newUserEmail, setNewUserEmail] = useState('');
            const [newUserPassword, setNewUserPassword] = useState('');
            const [newUserDisplayName, setNewUserDisplayName] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                loadUsers();
            }, []);

            const loadUsers = async () => {
                try {
                    console.log('Loading users...');
                    // Load real users from Supabase Auth using admin client
                    const { data, error } = await adminSupabase.auth.admin.listUsers();
                    if (error) {
                        console.error('Error loading users:', error);
                        alert('Error loading users: ' + error.message);
                        setUsers([]);
                        return;
                    }
                    console.log('Users loaded:', data);
                    if (!data || !data.users) {
                        console.log('No users data returned');
                        setUsers([]);
                        return;
                    }
                    
                    // Filter out the current admin user and format the data
                    const currentUserId = user?.id;
                    const filteredUsers = data.users
                        .filter(user => user.id !== currentUserId) // Don't show current admin user
                        .map(user => ({
                            id: user.id,
                            email: user.email,
                            display_name: user.user_metadata?.display_name || 'No Name',
                            created_at: user.created_at
                        }));
                    
                    console.log('Filtered users:', filteredUsers);
                    setUsers(filteredUsers);
                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('Error loading users: ' + error.message);
                    setUsers([]);
                }
            };

            const handleAddUser = async (e) => {
                e.preventDefault();
                if (!newUserEmail || !newUserPassword || !newUserDisplayName) return;
                
                setLoading(true);
                try {
                    // Create real user in Supabase Auth using admin client
                    const { data, error } = await adminSupabase.auth.admin.createUser({
                        email: newUserEmail,
                        password: newUserPassword,
                        user_metadata: { display_name: newUserDisplayName },
                        email_confirm: true // Auto-confirm email for testing
                    });
                    
                    if (error) throw error;
                    
                    // Add to local users list
                    const newUser = {
                        id: data.user.id,
                        email: data.user.email,
                        display_name: newUserDisplayName,
                        created_at: data.user.created_at
                    };
                    setUsers([...users, newUser]);
                    setNewUserEmail('');
                    setNewUserPassword('');
                    setNewUserDisplayName('');
                    alert(`User ${newUserEmail} created successfully!`);
                    
                    // Refresh the users list to ensure sync
                    setTimeout(() => loadUsers(), 1000);
                } catch (error) {
                    alert('Error adding user: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-6xl">
                    <div className="flex justify-between items-center mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Admin Panel</h1>
                        <div className="flex items-center gap-3">
                            <button
                                onClick={onSignOut}
                                className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"
                            >
                                Sign Out
                            </button>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* User Management */}
                        <div className="modern-card p-6">
                            <h2 className="text-2xl font-bold mb-4 text-primary">User Management</h2>
                            
                            {/* Service Role Key Notice - Only show if not configured */}
                            {!useServiceRoleKey && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                    <div className="flex items-center gap-2">
                                        <span className="text-yellow-800">‚ö†Ô∏è</span>
                                        <div>
                                            <p className="text-yellow-800 font-medium">Admin Functions Setup Required</p>
                                            <p className="text-yellow-700 text-sm">
                                                To use admin functions (create/delete users), you need to:
                                            </p>
                                            <ol className="text-yellow-700 text-sm mt-2 list-decimal list-inside space-y-1">
                                                <li>Go to Supabase Dashboard ‚Üí Settings ‚Üí API</li>
                                                <li>Copy your "service_role" key</li>
                                                <li>Replace "YOUR_SERVICE_ROLE_KEY_HERE" in the code</li>
                                                <li>Set USE_SERVICE_ROLE_KEY = true</li>
                                            </ol>
                                            <p className="text-yellow-700 text-sm mt-2">
                                                <strong>Note:</strong> Service role keys have full database access - only use for development/testing.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Success Message - Show when service role key is configured */}
                            {useServiceRoleKey && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                    <div className="flex items-center gap-2">
                                        <span className="text-green-800">‚úÖ</span>
                                        <div>
                                            <p className="text-green-800 font-medium">Admin Functions Enabled!</p>
                                            <p className="text-green-700 text-sm">
                                                Service role key is configured. You can now create, manage, and delete users through this panel.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <form onSubmit={handleAddUser} className="space-y-4 mb-6">
                                <input
                                    type="email"
                                    placeholder="User Email"
                                    className="w-full p-3 border rounded-lg"
                                    value={newUserEmail}
                                    onChange={(e) => setNewUserEmail(e.target.value)}
                                    required
                                />
                                <input
                                    type="text"
                                    placeholder="Display Name"
                                    className="w-full p-3 border rounded-lg"
                                    value={newUserDisplayName}
                                    onChange={(e) => setNewUserDisplayName(e.target.value)}
                                    required
                                />
                                <input
                                    type="password"
                                    placeholder="Password"
                                    className="w-full p-3 border rounded-lg"
                                    value={newUserPassword}
                                    onChange={(e) => setNewUserPassword(e.target.value)}
                                    required
                                />
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 disabled:opacity-50"
                                >
                                    {loading ? 'Adding User...' : 'Add User'}
                                </button>
                            </form>
                            
                            <div className="space-y-2">
                                <div className="flex justify-between items-center">
                                    <h3 className="font-semibold">Current Users:</h3>
                                    <button
                                        onClick={loadUsers}
                                        className="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600"
                                    >
                                        üîÑ Refresh
                                    </button>
                                </div>
                                {users.length === 0 ? (
                                    <div className="text-center py-4 text-gray-500">
                                        No users found. Click refresh to load users.
                                    </div>
                                ) : (
                                    users.map(user => (
                                        <div key={user.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <div>
                                                <div className="font-medium">{user.display_name}</div>
                                                <div className="text-sm text-gray-600">{user.email}</div>
                                            </div>
                                            <button
                                                onClick={() => onRemoveUser(user.id)}
                                                className="text-red-500 hover:text-red-700"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                        
                        {/* System Info */}
                        <div className="modern-card p-6">
                            <h2 className="text-2xl font-bold mb-4 text-primary">System Information</h2>
                            <div className="space-y-3">
                                <div>
                                    <span className="font-medium">Admin User:</span> {user.email}
                                </div>
                                <div>
                                    <span className="font-medium">Total Users:</span> {users.length}
                                </div>
                                <div>
                                    <span className="font-medium">Environment:</span> Production
                                </div>
                                <div>
                                    <span className="font-medium">Database:</span> {TABLE_NAME}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const MarriageMeetingTool = () => {
            // Check if Supabase is available with better debugging
            console.log('üîç MarriageMeetingTool render check:', {
                'supabase exists': !!supabase,
                'adminSupabase exists': !!adminSupabase,
                'supabase type': typeof supabase,
                'adminSupabase type': typeof adminSupabase,
                'window.supabase exists': !!window.supabase,
                'window.supabase.createClient': typeof window.supabase?.createClient,
                'window.supabaseReady': window.supabaseReady
            });
            
            // Check global variables first, then fall back to local ones
            const isSupabaseAvailable = (window.supabase && window.adminSupabase) || 
                                     (supabase && adminSupabase) ||
                                     (window.supabase && typeof window.supabase.createClient === 'function');
            
            if (!isSupabaseAvailable) {
                console.log('‚ùå Supabase clients not ready, showing loading screen');
                return (
                    <div className="min-h-screen flex items-center justify-center bg-white">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading Supabase...</p>
                            <p className="text-sm text-gray-500 mt-2">If this persists, please refresh the page</p>
                            <div className="mt-4 text-xs text-gray-400">
                                <p>Local supabase: {supabase ? '‚úÖ' : '‚ùå'}</p>
                                <p>Local adminSupabase: {adminSupabase ? '‚úÖ' : '‚ùå'}</p>
                                <p>Global window.supabase: {window.supabase ? '‚úÖ' : '‚ùå'}</p>
                                <p>Global window.adminSupabase: {window.adminSupabase ? '‚úÖ' : '‚ùå'}</p>
                                <p>window.supabaseReady: {window.supabaseReady ? '‚úÖ' : '‚ùå'}</p>
                            </div>
                        </div>
                    </div>
                );
            }
            
            const [currentWeek, setCurrentWeek] = useState(new Date());
            const [weekData, setWeekData] = useState({});
            const [isConnected, setIsConnected] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [lastSaved, setLastSaved] = useState(null);
            const saveTimeoutRef = useRef(null);
            
            // Authentication state
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [authLoading, setAuthLoading] = useState(true);
            const [userModePreference, setUserModePreference] = useState('user');
            const [userSpecificData, setUserSpecificData] = useState({
                weekData: {},
                userPreferences: {}
            });

            // Get Monday of current week
            const getMonday = (date) => {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            };

            // Authentication and data management functions
            const handleSignIn = async (userData) => {
                console.log('üîê handleSignIn called for user:', userData.email);
                setUser(userData);
                setIsAdmin(false);
                setUserModePreference('user');
                
                // Load user-specific data from localStorage first (fastest)
                await loadUserSpecificData(userData.id);
                
                // CRITICAL: Always try to sync with Supabase to get cross-device data
                try {
                    console.log('üîÑ CRITICAL: Syncing with Supabase for cross-device data...');
                    
                    // Try with RLS first
                    let { data, error } = await supabase
                        .from(TABLE_NAME)
                        .select('*')
                        .eq('user_id', userData.id);
                    
                    // If RLS fails, try with service role key for admin access
                    if (error && USE_SERVICE_ROLE_KEY) {
                        console.log('üîÑ RLS failed, trying with service role key for cross-device sync...');
                        const { data: adminData, error: adminError } = await supabase
                            .from(TABLE_NAME)
                            .select('*')
                            .eq('user_id', userData.id);
                        
                        if (!adminError && adminData) {
                            data = adminData;
                            error = null;
                            console.log('‚úÖ Service role key worked for cross-device sync');
                        }
                    }
                    
                    if (!error && data && data.length > 0) {
                        console.log(`üåê Found ${data.length} weeks in Supabase for cross-device sync`);
                        
                        let hasNewData = false;
                        
                        // Always sync Supabase data to localStorage for cross-device access
                        data.forEach(row => {
                            const localStorageKey = `marriage_meetings_${userData.id}_${row.week_key}`;
                            const localData = localStorage.getItem(localStorageKey);
                            
                            // Check if we need to update localStorage
                            if (!localData) {
                                // No local data, definitely sync from Supabase
                                localStorage.setItem(localStorageKey, JSON.stringify(row.data));
                                console.log(`üíæ SYNCED: Week ${row.week_key} from Supabase to localStorage (new data)`);
                                hasNewData = true;
                            } else {
                                try {
                                    const parsedLocal = JSON.parse(localData);
                                    const localUpdatedAt = parsedLocal.updated_at || 0;
                                    const supabaseUpdatedAt = new Date(row.updated_at || 0).getTime();
                                    
                                    if (supabaseUpdatedAt > localUpdatedAt) {
                                        // Supabase has newer data, update localStorage
                                        localStorage.setItem(localStorageKey, JSON.stringify(row.data));
                                        console.log(`üíæ SYNCED: Week ${row.week_key} from Supabase to localStorage (newer data)`);
                                        hasNewData = true;
                                    } else {
                                        console.log(`‚úÖ Week ${row.week_key} already up to date`);
                                    }
                                } catch (parseError) {
                                    // Local data corrupted, sync from Supabase
                                    localStorage.setItem(localStorageKey, JSON.stringify(row.data));
                                    console.log(`üíæ SYNCED: Week ${row.week_key} from Supabase to localStorage (corrupted local data)`);
                                    hasNewData = true;
                                }
                            }
                        });
                        
                        if (hasNewData) {
                            console.log('üîÑ Reloading data after Supabase sync...');
                            await loadUserSpecificData(userData.id);
                        } else {
                            console.log('‚úÖ No new data to sync from Supabase');
                        }
                    } else if (error) {
                        console.log('‚ùå Supabase sync failed:', error);
                        console.log('üì± Your phone may not have access to data created on other devices');
                    } else {
                        console.log('üì≠ No data found in Supabase for cross-device sync');
                    }
                } catch (syncError) {
                    console.error('‚ùå CRITICAL: Supabase sync error:', syncError);
                    console.log('üì± Cross-device sync failed - your phone may not see data from other devices');
                }
                
                // CRITICAL: Set loading to false after sign-in is complete
                console.log('üîê handleSignIn complete, setting isLoading to false');
                setIsLoading(false);
            };

            const handleAdminSignIn = async (userData) => {
                setUser(userData);
                setIsAdmin(true);
                setUserModePreference('admin');
                
                // Load user-specific data from localStorage
                await loadUserSpecificData(userData.id);
            };

            const handleSignOut = async () => {
                try {
                    console.log('üö™ Signing out...');
                    
                    // Force immediate state updates to trigger re-render
                    setUser(null);
                    setIsAdmin(false);
                    setUserModePreference('user');
                    setUserSpecificData({ weekData: {}, userPreferences: {} });
                    setWeekData({});
                    setCurrentWeek(new Date()); // Reset week to force re-render
                    setIsLoading(false); // Ensure loading state is cleared
                    
                    // Clear any pending timeouts
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                        saveTimeoutRef.current = null;
                    }
                    
                    // DON'T clear localStorage data - keep it for when user signs back in
                    // This prevents data loss and allows seamless sign-in/sign-out
                    console.log('üíæ Keeping localStorage data for seamless re-authentication');
                    
                    // Then sign out from Supabase
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        console.error('Supabase signout error:', error);
                    } else {
                        console.log('‚úÖ Successfully signed out from Supabase');
                    }
                    
                    console.log('üéØ Signout complete - should show login screen now');
                    
                } catch (error) {
                    console.error('Signout error:', error);
                    // Even if there's an error, we've cleared local state
                    console.log('üéØ Signout complete despite error - should show login screen now');
                }
            };

            const switchAdminToUserMode = async () => {
                setUserModePreference('user');
                setIsAdmin(false);
                
                // Load admin's personal data when switching to user mode
                await loadUserSpecificData(user.id);
            };

            const switchUserToAdminMode = () => {
                setUserModePreference('admin');
                setIsAdmin(true);
            };

            // Data persistence functions
            const saveWeekData = async (weekKey, data) => {
                try {
                    // Save to localStorage first (primary)
                    const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                    localStorage.setItem(localStorageKey, JSON.stringify(data));
                    
                    // Save to Supabase as backup
                    const { error } = await supabase
                        .from(TABLE_NAME)
                        .upsert({
                            week_key: weekKey,
                            user_id: user.id,
                            data: data,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'week_key,user_id'
                        });

                    if (error) {
                        console.log('Supabase save error:', error);
                        // Continue even if Supabase fails - localStorage is primary
                    }

                    setLastSaved(new Date());
                    return true;
                } catch (error) {
                    console.log('Save error:', error);
                    return false;
                }
            };

            const loadUserSpecificData = async (userId) => {
                try {
                    console.log(`üîÑ Loading user-specific data for user: ${userId}`);
                    
                    // Try to load from localStorage first (primary source)
                    const localStorageKeys = Object.keys(localStorage).filter(key => 
                        key.startsWith(`marriage_meetings_${userId}_`)
                    );
                    
                    console.log(`üîç Found localStorage keys:`, localStorageKeys);
                    
                    if (localStorageKeys.length > 0) {
                        console.log(`üìä Found ${localStorageKeys.length} weeks of data in localStorage`);
                        
                        const loadedWeekData = {};
                        localStorageKeys.forEach(key => {
                            const weekKey = key.replace(`marriage_meetings_${userId}_`, '');
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                loadedWeekData[weekKey] = data;
                                console.log(`‚úÖ Loaded week from localStorage: ${weekKey}`, data);
                            } catch (parseError) {
                                console.error(`‚ùå Error parsing localStorage data for week ${weekKey}:`, parseError);
                            }
                        });
                        
                        console.log(`üìä Final loaded week data:`, loadedWeekData);
                        console.log(`üìä Week keys:`, Object.keys(loadedWeekData));
                        
                        // Update both states immediately
                        setUserSpecificData(prev => ({
                            ...prev,
                            weekData: loadedWeekData
                        }));
                        setWeekData(loadedWeekData);
                        
                        console.log('üéâ Successfully loaded all data from localStorage');
                        return; // Exit early - localStorage is our primary source
                    }

                    console.log('üì≠ No localStorage data found, trying Supabase...');
                    
                    // Fallback to Supabase if no localStorage data
                    try {
                        const { data, error } = await supabase
                            .from(TABLE_NAME)
                            .select('*')
                            .eq('user_id', userId);

                        if (error) {
                            console.log('‚ùå Error loading from Supabase:', error);
                            
                            // If RLS fails, try with service role key for admin access
                            if (USE_SERVICE_ROLE_KEY && error.code === 'PGRST116') {
                                console.log('üîÑ Trying with service role key for user data...');
                                const { data: adminData, error: adminError } = await supabase
                                    .from(TABLE_NAME)
                                    .select('*')
                                    .eq('user_id', userId);
                                
                                if (adminError) {
                                    console.log('Service role key also failed for user data:', adminError);
                                    // Set empty state and continue
                                    setUserSpecificData(prev => ({
                                        ...prev,
                                        weekData: {}
                                    }));
                                    setWeekData({});
                                    return;
                                }
                                
                                if (adminData && adminData.length > 0) {
                                    console.log(`üåê Loaded ${adminData.length} weeks from Supabase with service role`);
                                    
                                    const loadedWeekData = {};
                                    adminData.forEach(row => {
                                        loadedWeekData[row.week_key] = row.data;
                                        
                                        // Also save to localStorage for future use
                                        const localStorageKey = `marriage_meetings_${userId}_${row.week_key}`;
                                        localStorage.setItem(localStorageKey, JSON.stringify(row.data));
                                        console.log(`üíæ Saved week ${row.week_key} to localStorage`);
                                    });
                                    
                                    setUserSpecificData(prev => ({
                                        ...prev,
                                        weekData: loadedWeekData
                                    }));
                                    setWeekData(loadedWeekData);
                                    
                                    console.log('‚úÖ Successfully loaded and cached data from Supabase with service role');
                                    return;
                                }
                            }
                            
                            // If we get here, no data was found anywhere
                            console.log('üì≠ No data found in localStorage or Supabase, setting empty state');
                            setUserSpecificData(prev => ({
                                ...prev,
                                weekData: {}
                            }));
                            setWeekData({});
                            return;
                        }

                        if (data && data.length > 0) {
                            console.log(`üåê Loaded ${data.length} weeks from Supabase`);
                            
                            const loadedWeekData = {};
                            data.forEach(row => {
                                loadedWeekData[row.week_key] = row.data;
                                
                                // Also save to localStorage for future use
                                const localStorageKey = `marriage_meetings_${userId}_${row.week_key}`;
                                localStorage.setItem(localStorageKey, JSON.stringify(row.data));
                                console.log(`üíæ Saved week ${row.week_key} to localStorage`);
                            });
                            
                            setUserSpecificData(prev => ({
                                ...prev,
                                weekData: loadedWeekData
                            }));
                            setWeekData(loadedWeekData);
                            
                            console.log('‚úÖ Successfully loaded and cached data from Supabase');
                        } else {
                            console.log('üì≠ No data found in Supabase either');
                        }
                    } catch (error) {
                        console.error('‚ùå Error in loadUserSpecificData:', error);
                    }
                } catch (error) {
                    console.error('‚ùå Error in loadUserSpecificData outer try:', error);
                }
            };

            const clearUserData = () => {
                console.log('üö® clearUserData called - this should only happen when switching users');
                // Only clear data when switching between different users, not on signout
                setUserSpecificData({ weekData: {}, userPreferences: {} });
                setWeekData({});
            };

            // Debug function to manually check and restore data from Supabase
            const debugCheckSupabaseData = async () => {
                if (!user) return;
                
                console.log('üîç DEBUG: Checking Supabase for user data...');
                console.log('User ID:', user.id);
                console.log('User Email:', user.email);
                
                try {
                    // Try to get all data for this user from Supabase
                    const { data, error } = await supabase
                        .from(TABLE_NAME)
                        .select('*')
                        .eq('user_id', user.id);
                    
                    if (error) {
                        console.error('‚ùå Supabase query error:', error);
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        console.log(`‚úÖ Found ${data.length} weeks of data in Supabase:`, data);
                        
                        // Restore the data to localStorage and state
                        const restoredWeekData = {};
                        data.forEach(row => {
                            restoredWeekData[row.week_key] = row.data;
                            
                            // Save to localStorage
                            const localStorageKey = `marriage_meetings_${user.id}_${row.week_key}`;
                            localStorage.setItem(localStorageKey, JSON.stringify(row.data));
                            console.log(`üíæ Restored week ${row.week_key} to localStorage`);
                        });
                        
                        // Update state
                        setUserSpecificData(prev => ({
                            ...prev,
                            weekData: restoredWeekData
                        }));
                        setWeekData(restoredWeekData);
                        
                        console.log('üéâ Data restored successfully!');
                        alert(`Restored ${data.length} weeks of data from Supabase!`);
                    } else {
                        console.log('üì≠ No data found in Supabase for this user');
                    }
                } catch (error) {
                    console.error('‚ùå Debug function error:', error);
                }
            };

            const formatWeekKey = (date) => {
                const monday = getMonday(date);
                return monday.toISOString().split('T')[0];
            };

            const formatWeekDisplay = (date) => {
                const monday = getMonday(date);
                const sunday = new Date(monday);
                sunday.setDate(sunday.getDate() + 6);
                
                return `${monday.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${sunday.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            };





            // Enhanced debounced save with mobile optimization - faster saves on mobile devices
            const debouncedSave = useCallback((weekKey, data) => {
                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }
                
                // Faster saves on mobile devices for better data persistence
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const saveDelay = isMobile ? 500 : 1000; // 500ms on mobile, 1000ms on desktop
                
                saveTimeoutRef.current = setTimeout(() => {
                    saveWeekData(weekKey, data);
                }, saveDelay);
            }, []);

            // Immediate localStorage save for instant persistence
            const saveToLocalStorage = useCallback((weekKey, data) => {
                if (!user) return;
                
                try {
                    const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                    localStorage.setItem(localStorageKey, JSON.stringify(data));
                    console.log(`üíæ Saved to localStorage: ${weekKey}`);
                } catch (error) {
                    console.error('‚ùå Error saving to localStorage:', error);
                }
            }, [user]);

            // Initialize database
            const initializeDatabase = async () => {
                setIsConnected(true);
            };

            // Initialize week data with robust localStorage persistence
            const initializeWeekData = useCallback(async () => {
                const weekKey = formatWeekKey(currentWeek);
                
                // First check if we already have this week's data in state
                if (weekData[weekKey]) {
                    return weekData[weekKey];
                }

                setIsLoading(true);
                
                try {
                    // Try to load from localStorage first (primary source)
                    if (user) {
                        const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                        const savedData = localStorage.getItem(localStorageKey);
                        
                        if (savedData) {
                            console.log(`üìä Found data in localStorage for week: ${weekKey}`);
                            const parsedData = JSON.parse(savedData);
                            setWeekData(prev => ({ ...prev, [weekKey]: parsedData }));
                            setIsLoading(false);
                            return parsedData;
                        }
                    }

                    // Check if we have user-specific data from previous loads
                    if (user && userSpecificData.weekData[weekKey]) {
                        console.log(`üîÑ Found data in userSpecificData for week: ${weekKey}`);
                        setWeekData(prev => ({ ...prev, [weekKey]: userSpecificData.weekData[weekKey] }));
                        setIsLoading(false);
                        return userSpecificData.weekData[weekKey];
                    }

                    // Fallback to Supabase if no localStorage data
                    if (user) {
                        console.log(`üåê Loading from Supabase for week: ${weekKey}`);
                        try {
                            // Try with RLS policies first
                            const { data, error } = await supabase
                                .from(TABLE_NAME)
                                .select('*')
                                .eq('week_key', weekKey)
                                .eq('user_id', user.id);

                            if (error) {
                                console.log('Supabase load error with RLS:', error);
                                
                                // If RLS fails, try with service role key for admin access
                                if (USE_SERVICE_ROLE_KEY && error.code === 'PGRST116') {
                                    console.log('üîÑ Trying with service role key...');
                                    const { data: adminData, error: adminError } = await supabase
                                        .from(TABLE_NAME)
                                        .select('*')
                                        .eq('week_key', weekKey)
                                        .eq('user_id', user.id);
                                    
                                    if (adminError) {
                                        console.log('Service role key also failed:', adminError);
                                    } else if (adminData && adminData.length > 0) {
                                        console.log(`‚úÖ Loaded data with service role for week: ${weekKey}`);
                                        const supabaseData = adminData[0].data;
                                        setWeekData(prev => ({ ...prev, [weekKey]: supabaseData }));
                                        
                                        // Also save to localStorage for future use
                                        const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                                        localStorage.setItem(localStorageKey, JSON.stringify(supabaseData));
                                        
                                        setIsLoading(false);
                                        return supabaseData;
                                    }
                                }
                            } else if (data && data.length > 0) {
                                console.log(`‚úÖ Loaded data from Supabase for week: ${weekKey}`);
                                const supabaseData = data[0].data;
                                setWeekData(prev => ({ ...prev, [weekKey]: supabaseData }));
                                
                                // Also save to localStorage for future use
                                const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                                localStorage.setItem(localStorageKey, JSON.stringify(supabaseData));
                                
                                setIsLoading(false);
                                return supabaseData;
                            }
                        } catch (supabaseError) {
                            console.log('Supabase connection error:', supabaseError);
                        }
                    }

                    // Create new week data if nothing found
                    console.log(`üÜï Creating new week data for: ${weekKey}`);
                    const newWeekData = {
                        schedule: {
                            Monday: [''], Tuesday: [''], Wednesday: [''], Thursday: [''],
                            Friday: [''], Saturday: [''], Sunday: ['']
                        },
                        todos: [], prayers: [], goals: [], grocery: [], unconfessedSin: [], weeklyWinddown: []
                    };

                    setWeekData(prev => ({ ...prev, [weekKey]: newWeekData }));
                    
                    // Save to localStorage immediately
                    if (user) {
                        const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                        localStorage.setItem(localStorageKey, JSON.stringify(newWeekData));
                        console.log(`üíæ Saved new week data to localStorage: ${weekKey}`);
                    }
                    
                    setIsLoading(false);
                    return newWeekData;
                    
                } catch (error) {
                    console.error('Error initializing week data:', error);
                    setIsLoading(false);
                    
                    // Return basic structure even if there's an error
                    const fallbackData = {
                        schedule: {
                            Monday: [''], Tuesday: [''], Wednesday: [''], Thursday: [''],
                            Friday: [''], Saturday: [''], Sunday: ['']
                        },
                        todos: [], prayers: [], goals: [], grocery: [], unconfessedSin: [], weeklyWinddown: []
                    };
                    
                    setWeekData(prev => ({ ...prev, [weekKey]: fallbackData }));
                    return fallbackData;
                }
            }, [currentWeek, weekData, user, userSpecificData.weekData]);

            // Initialize on mount
            useEffect(() => {
                initializeDatabase().then(() => {
                    if (user) {
                        initializeWeekData();
                    }
                });
            }, [initializeWeekData, user]);

            // Listen for Supabase ready event and also poll for readiness
            useEffect(() => {
                const handleSupabaseReady = () => {
                    console.log('üéâ Received supabaseReady event, forcing re-render');
                    // Force a re-render by updating a state variable
                    setAuthLoading(prev => !prev);
                };
                
                // Set up the global force update function
                window.forceReactUpdate = () => {
                    console.log('üîÑ Global force update called');
                    setAuthLoading(prev => !prev);
                };
                
                window.addEventListener('supabaseReady', handleSupabaseReady);
                
                // Also poll every 100ms to check if Supabase is ready
                const pollInterval = setInterval(() => {
                    if (window.supabaseReady && (window.supabase || window.adminSupabase)) {
                        console.log('üîç Polling detected Supabase is ready, forcing re-render');
                        clearInterval(pollInterval);
                        setAuthLoading(prev => !prev);
                    }
                }, 100);
                
                return () => {
                    window.removeEventListener('supabaseReady', handleSupabaseReady);
                    clearInterval(pollInterval);
                    delete window.forceReactUpdate;
                };
            }, []);
            
            // Initialize authentication
            useEffect(() => {
                const initializeAuth = async () => {
                    try {
                        console.log('üîê Starting auth initialization...');
                        
                        // Check for existing session
                        const { data: { session } } = await supabase.auth.getSession();
                        console.log('üîê Session check result:', !!session?.user);
                        
                        if (session?.user) {
                            console.log('üîê Found existing session for user:', session.user.email);
                            const isUserAdmin = session.user.user_metadata?.is_admin === true;
                            if (isUserAdmin) {
                                console.log('üîê User is admin, calling handleAdminSignIn');
                                await handleAdminSignIn(session.user);
                            } else {
                                console.log('üîê User is regular user, calling handleSignIn');
                                await handleSignIn(session.user);
                            }
                        } else {
                            console.log('üîê No existing session found');
                        }
                        
                        // Listen for auth changes
                        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
                            console.log('üîê Auth state change:', event, session?.user?.email);
                            
                            if (event === 'SIGNED_IN' && session?.user) {
                                const isUserAdmin = session.user.user_metadata?.is_admin === true;
                                if (isUserAdmin) {
                                    await handleAdminSignIn(session.user);
                                } else {
                                    await handleSignIn(session.user);
                                }
                            } else if (event === 'SIGNED_OUT') {
                                // Don't call handleSignOut here to avoid circular dependency
                                // Just clear local state
                                setUser(null);
                                setIsAdmin(false);
                                setUserModePreference('user');
                                // DON'T clear weekData here - it will be handled by handleSignOut
                                console.log('üîÑ Auth state change: cleared local state (preserving weekData)');
                            }
                        });
                        
                        console.log('üîê Auth initialization complete, setting authLoading to false');
                        setAuthLoading(false);
                        return () => subscription.unsubscribe();
                    } catch (error) {
                        console.error('‚ùå Auth initialization error:', error);
                        console.log('üîê Setting authLoading to false due to error');
                        setAuthLoading(false);
                    }
                };
                
                // Add timeout to prevent infinite loading
                const authTimeout = setTimeout(() => {
                    console.log('‚è∞ Auth initialization timeout - forcing authLoading to false');
                    setAuthLoading(false);
                }, 10000); // 10 second timeout
                
                initializeAuth().finally(() => {
                    clearTimeout(authTimeout);
                });
            }, []);

            // Load all user data from localStorage when user changes
            useEffect(() => {
                if (user) {
                    console.log('üîÑ User changed, loading data from localStorage...');
                    console.log('üîÑ User ID:', user.id);
                    console.log('üîÑ User email:', user.email);
                    
                    // Debug: Check what's actually in localStorage
                    console.log('üîç DEBUG: All localStorage keys:');
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.includes('marriage_meetings')) {
                            console.log('  ', key, ':', localStorage.getItem(key)?.substring(0, 100) + '...');
                        }
                    }
                    
                    loadAllUserDataFromLocalStorage();
                }
            }, [user]);

            // DEBUG: Monitor when userSpecificData.weekData changes to catch data clearing
            useEffect(() => {
                if (user && !isAdmin) {
                    console.log('üîç DEBUG: userSpecificData.weekData changed');
                    console.log('üîç New weekData keys:', Object.keys(userSpecificData.weekData));
                    console.log('üîç WeekData length:', Object.keys(userSpecificData.weekData).length);
                    
                    // Check if data was just cleared
                    if (Object.keys(userSpecificData.weekData).length === 0) {
                        console.log('üö® WARNING: weekData was just cleared to empty!');
                        console.log('üö® This might indicate a race condition or incorrect clearing');
                        console.trace('Stack trace for weekData clearing');
                        
                        // Try to restore data immediately if it was cleared unexpectedly
                        setTimeout(() => {
                            console.log('üö® Attempting to restore data after unexpected clearing...');
                            loadAllUserDataFromLocalStorage();
                        }, 100);
                    }
                }
            }, [userSpecificData.weekData, user, isAdmin]);

            // Function to force save all current data (useful for mobile)
            const forceSaveAllData = useCallback(() => {
                if (!user || !currentWeek) return;
                
                const weekKey = formatWeekKey(currentWeek);
                const currentData = weekData[weekKey];
                if (currentData) {
                    // Save to localStorage immediately
                    saveToLocalStorage(weekKey, currentData);
                    // Save to Supabase as backup
                    saveWeekData(weekKey, currentData);
                    console.log('üíæ Force save all data triggered');
                    setLastSaved(new Date());
                }
            }, [user, currentWeek, weekData, saveToLocalStorage, saveWeekData]);

            // Function to load all user data from localStorage - BULLETPROOF approach
            const loadAllUserDataFromLocalStorage = () => {
                if (!user) return;
                
                try {
                    console.log('üîÑ BULLETPROOF: Loading all user data from localStorage...');
                    console.log('üîÑ User ID:', user.id);
                    
                    // Get all localStorage keys for this user
                    const localStorageKeys = Object.keys(localStorage).filter(key => 
                        key.startsWith(`marriage_meetings_${user.id}_`)
                    );
                    
                    console.log('üîë Found localStorage keys:', localStorageKeys);
                    
                    if (localStorageKeys.length > 0) {
                        console.log(`üìä Found ${localStorageKeys.length} weeks of data in localStorage`);
                        
                        const loadedWeekData = {};
                        localStorageKeys.forEach(key => {
                            const weekKey = key.replace(`marriage_meetings_${user.id}_`, '');
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                loadedWeekData[weekKey] = data;
                                console.log(`‚úÖ Loaded week: ${weekKey}`, data);
                            } catch (parseError) {
                                console.error(`‚ùå Error parsing localStorage data for week ${weekKey}:`, parseError);
                            }
                        });
                        
                        console.log('üìä Final loaded week data:', loadedWeekData);
                        console.log('üìä Week keys:', Object.keys(loadedWeekData));
                        
                        // Update both states - FORCE update
                        setUserSpecificData(prev => {
                            const newState = {
                                ...prev,
                                weekData: loadedWeekData
                            };
                            console.log('üîÑ Setting userSpecificData to:', newState);
                            return newState;
                        });
                        
                        setWeekData(loadedWeekData);
                        
                        console.log('üéâ BULLETPROOF: Successfully loaded all user data from localStorage');
                        console.log('üéâ State should now contain:', Object.keys(loadedWeekData).length, 'weeks');
                    } else {
                        console.log('üì≠ No localStorage data found for user');
                        
                        // Set empty state to prevent undefined errors
                        setUserSpecificData(prev => ({
                            ...prev,
                            weekData: {}
                        }));
                        setWeekData({});
                    }
                } catch (error) {
                    console.error('‚ùå CRITICAL ERROR loading localStorage data:', error);
                    
                    // Emergency fallback - set empty state
                    setUserSpecificData(prev => ({
                        ...prev,
                        weekData: {}
                    }));
                    setWeekData({});
                }
            };

            // User management functions
            const handleAddUser = async (email, password, displayName) => {
                try {
                    const { data, error } = await adminSupabase.auth.admin.createUser({
                        email,
                        password,
                        user_metadata: { display_name: displayName },
                        email_confirm: true
                    });
                    
                    if (error) throw error;
                    return data.user;
                } catch (error) {
                    console.error('Error adding user:', error);
                    throw error;
                }
            };

            const handleRemoveUser = async (userId) => {
                try {
                    // Check if user exists in Supabase
                    const { data: userData, error: getUserError } = await adminSupabase.auth.admin.getUserById(userId);
                    if (getUserError || !userData.user) {
                        console.log('User not found in Supabase, removing from local state only');
                        return;
                    }
                    
                    const { error } = await adminSupabase.auth.admin.deleteUser(userId);
                    if (error) throw error;
                } catch (error) {
                    console.error('Error removing user:', error);
                    throw error;
                }
            };

            // Enhanced timeout management with mobile auto-save
            useEffect(() => {
                let autoSaveInterval;
                
                // Set up periodic auto-save for mobile devices (every 30 seconds)
                if (user && currentWeek) {
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        autoSaveInterval = setInterval(() => {
                            const weekKey = formatWeekKey(currentWeek);
                            const currentData = weekData[weekKey];
                            if (currentData) {
                                // Save to localStorage immediately
                                saveToLocalStorage(weekKey, currentData);
                                // Also save to Supabase as backup
                                saveWeekData(weekKey, currentData);
                                console.log('üì± Mobile auto-save triggered');
                            }
                        }, 30000); // 30 seconds
                    }
                }
                
                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                    if (autoSaveInterval) {
                        clearInterval(autoSaveInterval);
                    }
                };
            }, [user, currentWeek, weekData, saveToLocalStorage, saveWeekData]);

            // Enhanced data persistence for mobile devices - handles tab switching, page refresh, and app switching
            useEffect(() => {
                const handleBeforeUnload = () => {
                    // Save current week data before page unload
                    if (user && currentWeek) {
                        const weekKey = formatWeekKey(currentWeek);
                        const currentData = weekData[weekKey];
                        if (currentData) {
                            const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                            localStorage.setItem(localStorageKey, JSON.stringify(currentData));
                            console.log('üíæ Saved data before page unload');
                        }
                    }
                };

                const handleVisibilityChange = () => {
                    // Save data when app goes to background (mobile) or tab becomes hidden
                    if (document.hidden && user && currentWeek) {
                        const weekKey = formatWeekKey(currentWeek);
                        const currentData = weekData[weekKey];
                        if (currentData) {
                            const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                            localStorage.setItem(localStorageKey, JSON.stringify(currentData));
                            console.log('üíæ Saved data on visibility change (app backgrounded)');
                        }
                    }
                };

                const handlePageHide = () => {
                    // Save data when page is about to be hidden (mobile app switching)
                    if (user && currentWeek) {
                        const weekKey = formatWeekKey(currentWeek);
                        const currentData = weekData[weekKey];
                        if (currentData) {
                            const localStorageKey = `marriage_meetings_${user.id}_${weekKey}`;
                            localStorage.setItem(localStorageKey, JSON.stringify(currentData));
                            console.log('üíæ Saved data on page hide (app switching)');
                        }
                    }
                };

                const handleFocus = () => {
                    // Reload data when app comes back to foreground (mobile)
                    if (user && !document.hidden) {
                        console.log('üì± App returned to foreground, ensuring data is loaded');
                        // Force a refresh of current week data
                        const weekKey = formatWeekKey(currentWeek);
                        if (weekData[weekKey]) {
                            // Trigger a re-render to ensure UI is up to date
                            setWeekData(prev => ({ ...prev }));
                        }
                    }
                };

                // Add all event listeners for comprehensive mobile support
                window.addEventListener('beforeunload', handleBeforeUnload);
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('pagehide', handlePageHide);
                window.addEventListener('focus', handleFocus);
                
                // Mobile-specific events
                if ('onpagehide' in window) {
                    // iOS Safari support
                    window.addEventListener('pagehide', handlePageHide);
                }
                
                if ('onbeforeunload' in window) {
                    // Standard browser support
                    window.addEventListener('beforeunload', handleBeforeUnload);
                }

                return () => {
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                    window.removeEventListener('pagehide', handlePageHide);
                    window.removeEventListener('focus', handleFocus);
                    
                    if ('onpagehide' in window) {
                        window.removeEventListener('pagehide', handlePageHide);
                    }
                    
                    if ('onbeforeunload' in window) {
                        window.removeEventListener('beforeunload', handleBeforeUnload);
                    }
                };
            }, [user, currentWeek, weekData]);

            // Use useMemo to properly calculate currentWeekData based on current state
            const currentWeekData = useMemo(() => {
                const weekKey = formatWeekKey(currentWeek);
                const existingData = userSpecificData.weekData[weekKey];
                
                // DEBUG: Log what's happening in currentWeekData calculation
                console.log('üîç currentWeekData useMemo running:');
                console.log('üîç Week key:', weekKey);
                console.log('üîç Existing data found:', !!existingData);
                console.log('üîç userSpecificData.weekData keys:', Object.keys(userSpecificData.weekData));
                
                if (existingData) {
                    console.log('üîç Returning existing data for week:', weekKey);
                    return existingData;
                }
                
                // Check if we should have data but it's missing
                if (Object.keys(userSpecificData.weekData).length > 0) {
                    console.log('üö® WARNING: Data exists in userSpecificData but not for this week');
                    console.log('üö® Available weeks:', Object.keys(userSpecificData.weekData));
                    console.log('üö® Requested week:', weekKey);
                    
                    // Try to restore data if it's missing for this specific week
                    if (user && !isAdmin) {
                        const weekDataKey = `marriage_meetings_${user.id}`;
                        
                        // Check all localStorage keys for this user
                        const allKeys = Object.keys(localStorage).filter(key => key.startsWith(weekDataKey));
                        console.log('üîç Found localStorage keys:', allKeys);
                        
                        for (const key of allKeys) {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                if (data && data[weekKey]) {
                                    console.log('üö® Found data for week in localStorage, updating state');
                                    setUserSpecificData(prev => ({
                                        ...prev,
                                        weekData: { ...prev.weekData, [weekKey]: data[weekKey] }
                                    }));
                                    return data[weekKey];
                                }
                            } catch (error) {
                                console.error('‚ùå Error parsing localStorage data:', error);
                            }
                        }
                    }
                }
                
                console.log('üîç Returning default structure for week:', weekKey);
                // Return default structure if no data exists
                return {
                    schedule: {
                        Monday: [''], Tuesday: [''], Wednesday: [''], Thursday: [''],
                        Friday: [''], Saturday: [''], Sunday: ['']
                    },
                    todos: [], prayers: [], goals: [], grocery: [], unconfessedSin: [], weeklyWinddown: []
                };
            }, [currentWeek, userSpecificData.weekData, user, isAdmin]);

            // Update functions
            const updateSchedule = (day, index, value) => {
                const weekKey = formatWeekKey(currentWeek);
                const newData = {
                    ...currentWeekData,
                    schedule: {
                        ...currentWeekData.schedule,
                        [day]: currentWeekData.schedule[day].map((item, i) => i === index ? value : item)
                    }
                };
                
                // Update BOTH state variables to keep them in sync
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                setUserSpecificData(prev => ({
                    ...prev,
                    weekData: { ...prev.weekData, [weekKey]: newData }
                }));
                
                // Save to localStorage immediately for instant persistence
                saveToLocalStorage(weekKey, newData);
                
                // Debounced save to Supabase
                debouncedSave(weekKey, newData);
                
                console.log('‚úèÔ∏è Updated schedule for day:', day, 'index:', index, 'value:', value);
            };

            const addScheduleLine = (day) => {
                const weekKey = formatWeekKey(currentWeek);
                const newData = {
                    ...currentWeekData,
                    schedule: {
                        ...currentWeekData.schedule,
                        [day]: [...currentWeekData.schedule[day], '']
                    }
                };
                
                // Update BOTH state variables to keep them in sync
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                setUserSpecificData(prev => ({
                    ...prev,
                    weekData: { ...prev.weekData, [weekKey]: newData }
                }));
                
                // Save to localStorage immediately
                saveToLocalStorage(weekKey, newData);
                
                // Save to Supabase
                saveWeekData(weekKey, newData);
                
                console.log('‚ûï Added schedule line for day:', day, 'New data:', newData);
            };

            const removeScheduleLine = (day, index) => {
                const weekKey = formatWeekKey(currentWeek);
                const newData = {
                    ...currentWeekData,
                    schedule: {
                        ...currentWeekData.schedule,
                        [day]: currentWeekData.schedule[day].filter((_, i) => i !== index)
                    }
                };
                
                // Update BOTH state variables to keep them in sync
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                setUserSpecificData(prev => ({
                    ...prev,
                    weekData: { ...prev.weekData, [weekKey]: newData }
                }));
                
                // Save to localStorage immediately
                saveToLocalStorage(weekKey, newData);
                
                // Save to Supabase
                saveWeekData(weekKey, newData);
                
                console.log('‚ûñ Removed schedule line for day:', day, 'index:', index, 'New data:', newData);
            };

            const addListItem = (listType) => {
                const weekKey = formatWeekKey(currentWeek);
                const currentItems = currentWeekData[listType] || [];
                const newItem = { id: Date.now(), text: '', completed: false };
                const newData = {
                    ...currentWeekData,
                    [listType]: [...currentItems, newItem]
                };
                
                // Update BOTH state variables to keep them in sync
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                setUserSpecificData(prev => ({
                    ...prev,
                    weekData: { ...prev.weekData, [weekKey]: newData }
                }));
                
                // Save to localStorage immediately
                saveToLocalStorage(weekKey, newData);
                
                // Save to Supabase
                saveWeekData(weekKey, newData);
                
                console.log('‚ûï Added list item for type:', listType, 'New data:', newData);
            };

            const updateListItem = (listType, id, text) => {
                const weekKey = formatWeekKey(currentWeek);
                const currentItems = currentWeekData[listType] || [];
                const updatedItems = currentItems.map(item => 
                    item.id === id ? { ...item, text } : item
                );
                const newData = {
                    ...currentWeekData,
                    [listType]: updatedItems
                };
                
                // Update BOTH state variables to keep them in sync
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                setUserSpecificData(prev => ({
                    ...prev,
                    weekData: { ...prev.weekData, [weekKey]: newData }
                }));
                
                // Save to localStorage immediately for instant persistence
                saveToLocalStorage(weekKey, newData);
                
                // Debounced save to Supabase
                debouncedSave(weekKey, newData);
                
                console.log('‚úèÔ∏è Updated list item for type:', listType, 'id:', id, 'text:', text);
            };

            const toggleListItem = (listType, id) => {
                const weekKey = formatWeekKey(currentWeek);
                const currentItems = currentWeekData[listType] || [];
                const updatedItems = currentItems.map(item => 
                    item.id === id ? { ...item, completed: !item.completed } : item
                );
                const newData = {
                    ...currentWeekData,
                    [listType]: updatedItems
                };
                
                // Update BOTH state variables to keep them in sync
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                setUserSpecificData(prev => ({
                    ...prev,
                    weekData: { ...prev.weekData, [weekKey]: newData }
                }));
                
                // Save to localStorage immediately
                saveToLocalStorage(weekKey, newData);
                
                // Save to Supabase
                saveWeekData(weekKey, newData);
                
                console.log('üîÑ Toggled list item for type:', listType, 'id:', id, 'completed:', !currentItems.find(item => item.id === id)?.completed);
            };

            const removeListItem = (listType, id) => {
                const weekKey = formatWeekKey(currentWeek);
                const currentItems = currentWeekData[listType] || [];
                const updatedItems = currentItems.filter(item => item.id !== id);
                const newData = {
                    ...currentWeekData,
                    [listType]: updatedItems
                };
                
                // Update BOTH state variables to keep them in sync
                setWeekData(prev => ({ ...prev, [weekKey]: newData }));
                setUserSpecificData(prev => ({
                    ...prev,
                    weekData: { ...prev.weekData, [weekKey]: newData }
                }));
                
                // Save to localStorage immediately
                saveToLocalStorage(weekKey, newData);
                
                // Save to Supabase
                saveWeekData(weekKey, newData);
                
                console.log('üóëÔ∏è Removed list item for type:', listType, 'id:', id);
            };

            const navigateWeek = (direction) => {
                const newDate = new Date(currentWeek);
                newDate.setDate(newDate.getDate() + (direction * 7));
                setCurrentWeek(newDate);
                
                // Ensure the new week's data is loaded
                const newWeekKey = formatWeekKey(newDate);
                if (user && !weekData[newWeekKey]) {
                    console.log(`üîÑ Navigating to new week: ${newWeekKey}, loading data...`);
                    initializeWeekData();
                }
            };

            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            // Show loading state
            if (authLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p className="text-gray-600">Initializing...</p>
                        </div>
                    </div>
                );
            }

            // Show sign-in screen if not authenticated
            console.log('üîç Render check - user state:', user ? user.email : 'null', 'isAdmin:', isAdmin);
            if (!user) {
                console.log('üéØ Rendering SignInScreen - user is null');
                return (
                    <SignInScreen 
                        onSignIn={handleSignIn}
                        onAdminSignIn={handleAdminSignIn}
                    />
                );
            }

            // Show admin panel if admin and in admin mode
            if (isAdmin && userModePreference === 'admin') {
                return (
                    <AdminPanel 
                        user={user}
                        onSignOut={handleSignOut}
                        onAddUser={handleAddUser}
                        onRemoveUser={handleRemoveUser}
                        useServiceRoleKey={USE_SERVICE_ROLE_KEY}
                    />
                );
            }

            // Show loading state for main app
            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading your marriage meeting...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl">
                    {/* Header Section */}
                    <div className="section-card rounded-xl p-6 mb-8">
                        <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="text-center md:text-left">
                                <h1 className="section-header text-4xl font-bold mb-2">
                                    Weekly Marriage Meeting
                                </h1>
                                <p className="text-gray-600 text-lg">
                                    Plan together, grow together
                                </p>
                                {user && (
                                    <div className="text-sm text-gray-500 mt-1">
                                        Signed in as: {user.email}
                                    </div>
                                )}
                            </div>
                            
                            <div className="flex items-center gap-4">
                                {/* Admin/User Mode Switch */}
                                {user?.user_metadata?.is_admin === true && (
                                    <div className="flex items-center gap-2">
                                        {userModePreference === 'admin' ? (
                                            <button
                                                onClick={switchAdminToUserMode}
                                                className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                                            >
                                                Switch to User Mode
                                            </button>
                                        ) : (
                                            <button
                                                onClick={switchUserToAdminMode}
                                                className="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors"
                                            >
                                                Admin Mode
                                            </button>
                                        )}
                                    </div>
                                )}
                                
                                {/* Debug Button - Show current data state */}
                                <button
                                    onClick={() => {
                                        console.log('üîç DEBUG: Current app state:');
                                        console.log('User:', user);
                                        console.log('Week Data:', weekData);
                                        console.log('User Specific Data:', userSpecificData);
                                        console.log('Current Week:', currentWeek);
                                        console.log('LocalStorage Keys:', Object.keys(localStorage).filter(key => key.startsWith('marriage_meetings_')));
                                        
                                        // Show data in alert for easy viewing
                                        const weekKeys = Object.keys(weekData);
                                        if (weekKeys.length > 0) {
                                            alert(`Found ${weekKeys.length} weeks of data:\n${weekKeys.join('\n')}`);
                                        } else {
                                            alert('No week data found in app state');
                                        }
                                    }}
                                    className="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors"
                                    title="Debug: Check current data state"
                                >
                                    üêõ Debug
                                </button>
                                
                                {/* Force Reload Data Button */}
                                <button
                                    onClick={() => {
                                        if (user) {
                                            console.log('üîÑ Force reloading data from localStorage...');
                                            loadAllUserDataFromLocalStorage();
                                            alert('Data reloaded! Check the console for details.');
                                        }
                                    }}
                                    className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                                    title="Force reload data from localStorage"
                                >
                                    üîÑ Reload Data
                                </button>

                                {/* Force Sync with Supabase Button */}
                                <button
                                    onClick={async () => {
                                        if (user) {
                                            console.log('üåê Force syncing with Supabase for cross-device data...');
                                            try {
                                                // Try with RLS first
                                                let { data, error } = await supabase
                                                    .from(TABLE_NAME)
                                                    .select('*')
                                                    .eq('user_id', user.id);
                                                
                                                // If RLS fails, try with service role key
                                                if (error && USE_SERVICE_ROLE_KEY) {
                                                    console.log('üîÑ RLS failed, trying with service role key...');
                                                    const { data: adminData, error: adminError } = await supabase
                                                        .from(TABLE_NAME)
                                                        .select('*')
                                                        .eq('user_id', user.id);
                                                    
                                                    if (!adminError && adminData) {
                                                        data = adminData;
                                                        error = null;
                                                    }
                                                }
                                                
                                                if (!error && data && data.length > 0) {
                                                    console.log(`üåê Found ${data.length} weeks in Supabase, syncing...`);
                                                    
                                                    let syncedCount = 0;
                                                    data.forEach(row => {
                                                        const localStorageKey = `marriage_meetings_${user.id}_${row.week_key}`;
                                                        localStorage.setItem(localStorageKey, JSON.stringify(row.data));
                                                        syncedCount++;
                                                    });
                                                    
                                                    // Reload data after sync
                                                    await loadAllUserDataFromLocalStorage();
                                                    
                                                    alert(`‚úÖ Synced ${syncedCount} weeks from Supabase! Your phone should now show all data.`);
                                                } else if (error) {
                                                    alert(`‚ùå Sync failed: ${error.message}\n\nYour phone may not have access to data from other devices.`);
                                                } else {
                                                    alert('üì≠ No data found in Supabase to sync.');
                                                }
                                            } catch (syncError) {
                                                console.error('‚ùå Manual sync error:', syncError);
                                                alert(`‚ùå Manual sync failed: ${syncError.message}`);
                                            }
                                        }
                                    }}
                                    className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                                    title="Force sync with Supabase for cross-device data"
                                >
                                    üåê Sync Cloud
                                </button>
                                
                                {/* Mobile Save Button */}
                                {/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && (
                                    <button
                                        onClick={forceSaveAllData}
                                        className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
                                        title="Force save all data"
                                    >
                                        üíæ Save Now
                                    </button>
                                )}
                                
                                {/* Sign Out Button */}
                                <button
                                    onClick={() => {
                                        console.log('üî¥ Sign Out button clicked!');
                                        handleSignOut();
                                    }}
                                    className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
                                >
                                    Sign Out
                                </button>
                                
                                <div className="text-right text-sm">
                                    <div className={`flex items-center gap-2 ${
                                        isConnected ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${
                                            isConnected ? 'bg-green-500' : 'bg-red-500'
                                        } status-indicator`}></div>
                                        {isConnected ? 'Synced' : 'Offline'}
                                    </div>
                                    {lastSaved && (
                                        <div className="text-gray-500">
                                            Last saved: {lastSaved.toLocaleTimeString()}
                                        </div>
                                    )}
                                    {/* Mobile save indicator */}
                                    {/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && (
                                        <div className="text-xs text-blue-600 font-medium">
                                            üì± Auto-saving every 30s
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="section-divider"></div>

                        {/* Week Navigation */}
                        <div className="flex items-center justify-center gap-6">
                            <button 
                                onClick={() => navigateWeek(-1)}
                                className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors shadow-sm"
                            >
                                <ChevronLeftIcon />
                                Previous Week
                            </button>
                            
                            <div className="text-center">
                                <h2 className="text-xl font-semibold text-gray-800">
                                    {formatWeekDisplay(currentWeek)}
                                </h2>
                                <p className="text-sm text-gray-500 mt-1">
                                    Week of {getMonday(currentWeek).toLocaleDateString('en-US', { weekday: 'long' })}
                                </p>
                            </div>
                            
                            <button 
                                onClick={() => navigateWeek(1)}
                                className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors shadow-sm"
                            >
                                Next Week
                                <ChevronRightIcon />
                            </button>
                        </div>
                    </div>

                    {/* Weekly Schedule Section */}
                    <div className="section-card rounded-xl p-6 mb-8">
                        {/* DEBUG: Show currentWeekData for debugging */}
                        {(() => {
                            console.log('üéØ UI RENDERING DEBUG: Rendering Weekly Schedule Section');
                            console.log('üéØ currentWeekData:', currentWeekData);
                            console.log('üéØ currentWeekData.schedule:', currentWeekData.schedule);
                            console.log('üéØ currentWeekData.todos:', currentWeekData.todos);
                            console.log('üéØ currentWeekData.prayers:', currentWeekData.prayers);
                            return null;
                        })()}
                        
                        <div className="text-center mb-6">
                            <h2 className="section-header text-2xl font-bold mb-2">
                                üìÖ Weekly Schedule
                            </h2>
                            <p className="text-gray-600">
                                Plan your week together, day by day
                            </p>
                        </div>

                        <div className="section-divider"></div>

                        <div className="flex flex-wrap justify-center gap-8 max-w-6xl mx-auto">
                            {days.map((day) => {
                                const dayItems = currentWeekData.schedule?.[day] || [''];
                                console.log(`üéØ Rendering day ${day}:`, dayItems);
                                return (
                                    <div key={day} className="w-full sm:w-[calc(50%-1rem)] lg:w-[calc(33.333%-1.33rem)] xl:w-[calc(25%-1.5rem)]">
                                        <ScheduleDay 
                                            day={day} 
                                            items={dayItems}
                                            onUpdate={updateSchedule}
                                            onAddLine={() => addScheduleLine(day)}
                                            onRemoveLine={(index) => removeScheduleLine(day, index)}
                                        />
                                    </div>
                                );
                            })}
                        </div>

                        <div className="section-divider mt-6"></div>
                        <div className="text-center">
                            <p className="text-sm text-gray-500">
                                Click in any day to add commitments, appointments, or notes
                            </p>
                        </div>
                    </div>

                    {/* Lists Section */}
                    <div className="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-8">
                        <ListSection 
                            title="‚úÖ To-Do List" 
                            subtitle="Tasks and action items"
                            listType="todos" 
                            items={currentWeekData.todos || []} 
                            onUpdate={updateListItem}
                            onAdd={addListItem}
                            onToggle={toggleListItem}
                            onRemove={removeListItem}
                            placeholder="Add a new task..."
                            color="blue"
                        />
                        
                        <ListSection 
                            title="üôè Prayer List" 
                            subtitle="Prayers and requests"
                            listType="prayers" 
                            items={currentWeekData.prayers || []} 
                            onUpdate={updateListItem}
                            onAdd={addListItem}
                            onToggle={toggleListItem}
                            onRemove={removeListItem}
                            placeholder="Add a prayer request..."
                            color="purple"
                        />
                        
                        <ListSection 
                            title="üéØ Goals" 
                            subtitle="Dreams and aspirations"
                            listType="goals" 
                            items={currentWeekData.goals || []} 
                            onUpdate={updateListItem}
                            onAdd={addListItem}
                            onToggle={toggleListItem}
                            onRemove={removeListItem}
                            placeholder="Add a new goal..."
                            color="green"
                        />
                        
                        <ListSection 
                            title="üõí Grocery List" 
                            subtitle="Shopping and supplies"
                            listType="grocery" 
                            items={currentWeekData.grocery || []} 
                            onUpdate={updateListItem}
                            onAdd={addListItem}
                            onToggle={toggleListItem}
                            onRemove={removeListItem}
                            placeholder="Add grocery item..."
                            color="orange"
                        />
                        
                        <ListSection 
                            title="üí≠ Unconfessed Sin" 
                            subtitle="Accountability and grace"
                            listType="unconfessedSin" 
                            items={currentWeekData.unconfessedSin || []} 
                            onUpdate={updateListItem}
                            onAdd={addListItem}
                            onToggle={toggleListItem}
                            onRemove={removeListItem}
                            placeholder="Add for accountability..."
                            color="red"
                        />
                        
                        <ListSection 
                            title="üåô Weekly Winddown" 
                            subtitle="Weekly relaxation plan together"
                            listType="weeklyWinddown" 
                            items={currentWeekData.weeklyWinddown || []} 
                            onUpdate={updateListItem}
                            onAdd={addListItem}
                            onToggle={toggleListItem}
                            onRemove={removeListItem}
                            placeholder="Add relaxation activity..."
                            color="blue"
                        />
                    </div>

                    {/* Footer */}
                    <div className="mt-12 text-center">
                        <div className="section-divider"></div>
                        <p className="text-gray-500 text-sm">
                            Built with ‚ù§Ô∏è for strengthening marriages through intentional planning
                        </p>
                        <p className="text-gray-400 text-xs mt-2">
                            All changes sync in real-time
                        </p>
                    </div>
                </div>
            );
        };

        // Schedule Day Component with local state for inputs
        const ScheduleDay = ({ day, items, onUpdate, onAddLine, onRemoveLine }) => {
            const [localInputs, setLocalInputs] = useState({});

            // Initialize local inputs when items change
            useEffect(() => {
                const newLocalInputs = {};
                items.forEach((item, index) => {
                    newLocalInputs[index] = item;
                });
                setLocalInputs(newLocalInputs);
            }, [items]);

            const handleInputChange = (index, value) => {
                setLocalInputs(prev => ({ ...prev, [index]: value }));
            };

            const handleInputBlur = (index) => {
                const localValue = localInputs[index];
                const currentItem = items[index];
                if (localValue !== undefined && currentItem !== localValue) {
                    onUpdate(day, index, localValue);
                }
            };

            const autoResize = (e) => {
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            };

            const dayColors = {
                Monday: 'border-slate-300 focus:border-slate-500 focus:ring-slate-200',
                Tuesday: 'border-slate-400 focus:border-slate-600 focus:ring-slate-200',
                Wednesday: 'border-purple-300 focus:border-purple-500 focus:ring-purple-200',
                Thursday: 'border-purple-400 focus:border-purple-600 focus:ring-purple-200',
                Friday: 'border-purple-500 focus:border-purple-700 focus:ring-purple-200',
                Saturday: 'border-purple-600 focus:border-purple-800 focus:ring-purple-200',
                Sunday: 'border-purple-700 focus:border-purple-900 focus:ring-purple-200'
            };

            return (
                <div className="modern-card p-8 min-h-[350px] flex flex-col w-full">
                    <div className="text-center mb-6">
                        <h3 className="font-bold text-gray-800 text-xl mb-3">
                            {day}
                        </h3>
                        <div className="w-full h-px bg-gradient-to-r from-transparent via-purple-300 to-transparent"></div>
                    </div>
                    
                    <div className="space-y-4 flex-1">
                        {items.map((line, index) => (
                            <div key={index} className="relative group">
                                <textarea
                                    value={localInputs[index] !== undefined ? localInputs[index] : line}
                                    onChange={(e) => {
                                        handleInputChange(index, e.target.value);
                                        autoResize(e);
                                    }}
                                    onBlur={() => handleInputBlur(index)}
                                    onInput={autoResize}
                                    className={`w-full text-base border-2 ${dayColors[day]} rounded-xl px-5 py-4 resize-none overflow-hidden min-h-[4rem] focus:outline-none focus:ring-2 focus:ring-current transition-all duration-200 placeholder-gray-400`}
                                    placeholder={`What's planned for ${day}?`}
                                    rows="1"
                                />
                                {items.length > 1 && (
                                    <button
                                        onClick={() => onRemoveLine(index)}
                                        className="absolute right-3 top-3 opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 p-2 bg-white rounded-full shadow-lg transition-all duration-200 hover:scale-110"
                                        title="Remove line"
                                    >
                                        <TrashIcon />
                                    </button>
                                )}
                            </div>
                        ))}
                        
                        <button
                            onClick={() => onAddLine()}
                            className="w-full text-base text-gray-600 hover:text-purple-700 py-4 border-2 border-dashed border-gray-300 hover:border-purple-400 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 hover:bg-purple-50 font-medium"
                        >
                            <PlusIcon />
                            Add another line
                        </button>
                    </div>
                </div>
            );
        };

        // List Section Component with local state for inputs
        const ListSection = ({ title, subtitle, listType, items, onUpdate, onAdd, onToggle, onRemove, placeholder, color }) => {
            const [localInputs, setLocalInputs] = useState({});

            // Initialize local inputs when items change
            useEffect(() => {
                const newLocalInputs = {};
                items.forEach(item => {
                    if (!(item.id in localInputs)) {
                        newLocalInputs[item.id] = item.text;
                    }
                });
                if (Object.keys(newLocalInputs).length > 0) {
                    setLocalInputs(prev => ({ ...prev, ...newLocalInputs }));
                }
            }, [items]);

            const handleInputChange = (id, value) => {
                setLocalInputs(prev => ({ ...prev, [id]: value }));
            };

            const handleInputBlur = (id) => {
                const localValue = localInputs[id];
                const currentItem = items.find(item => item.id === id);
                if (localValue !== undefined && currentItem && localValue !== currentItem.text) {
                    onUpdate(listType, id, localValue);
                }
            };

            const colorClasses = {
                blue: {
                    header: 'from-slate-400 to-slate-600',
                    border: 'border-slate-200',
                    button: 'bg-slate-50 hover:bg-slate-100 text-slate-700 border-slate-200'
                },
                purple: {
                    header: 'from-slate-500 to-purple-500',
                    border: 'border-slate-200',
                    button: 'bg-slate-50 hover:bg-slate-100 text-slate-700 border-slate-200'
                },
                green: {
                    header: 'from-purple-400 to-purple-600',
                    border: 'border-purple-200',
                    button: 'bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-200'
                },
                orange: {
                    header: 'from-purple-500 to-purple-700',
                    border: 'border-purple-200',
                    button: 'bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-200'
                },
                red: {
                    header: 'from-purple-600 to-purple-800',
                    border: 'border-purple-200',
                    button: 'bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-200'
                }
            };

            const colors = colorClasses[color];

            return (
                <div className={`modern-card border ${colors.border} overflow-hidden`}>
                    {/* Header */}
                    <div className={`bg-gradient-to-r ${colors.header} text-white p-6`}>
                        <h3 className="font-bold text-xl">{title}</h3>
                        <p className="text-white/90 text-sm mt-2">{subtitle}</p>
                    </div>

                    {/* Content */}
                    <div className="p-6">
                        <div className="space-y-4 mb-6">
                            {items.map((item) => (
                                <div key={item.id} className="flex items-start gap-4 group">
                                    <button
                                        onClick={() => onToggle(listType, item.id)}
                                        className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 hover:scale-110 ${
                                            item.completed 
                                                ? `bg-${color}-500 border-${color}-500 text-white shadow-lg` 
                                                : `border-gray-300 hover:border-${color}-400 hover:bg-gray-50`
                                        }`}
                                    >
                                        {item.completed && <CheckIcon />}
                                    </button>
                                    
                                    <div className="flex-1 min-w-0">
                                        <input
                                            type="text"
                                            value={localInputs[item.id] !== undefined ? localInputs[item.id] : item.text}
                                            onChange={(e) => handleInputChange(item.id, e.target.value)}
                                            onBlur={() => handleInputBlur(item.id)}
                                            className={`w-full text-sm border border-gray-200 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-${color}-400 focus:border-${color}-400 transition-all duration-200 ${
                                                item.completed ? 'line-through text-gray-500 bg-gray-50' : 'hover:border-gray-300'
                                            }`}
                                            placeholder={placeholder}
                                        />
                                    </div>
                                    
                                    <button
                                        onClick={() => onRemove(listType, item.id)}
                                        className="opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-all duration-200 hover:scale-110"
                                        title="Remove item"
                                    >
                                        <TrashIcon />
                                    </button>
                                </div>
                            ))}
                        </div>

                        {/* Add Button */}
                        <button
                            onClick={() => onAdd(listType)}
                            className={`w-full py-4 border-2 border-dashed rounded-xl transition-all duration-200 flex items-center justify-center gap-3 font-medium text-lg hover:scale-[1.02] ${colors.button}`}
                        >
                            <PlusIcon />
                            Add Item
                        </button>

                        {/* Footer Stats */}
                        {items.length > 0 && (
                            <div className="mt-6 pt-4 border-t border-gray-200">
                                <div className="flex justify-between text-sm text-gray-600 font-medium">
                                    <span>{items.length} total</span>
                                    <span>{items.filter(item => item.completed).length} completed</span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MarriageMeetingTool />, document.getElementById('root'));
    </script>
</body>
</html>
