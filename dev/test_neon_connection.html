<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Connection Test - The Daily David</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        #results { margin-top: 20px; padding: 20px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>🧪 Neon Database Connection Test</h1>
    <p>This page tests your Neon database connection for The Daily David app.</p>
    
    <button onclick="testConnection()">🔌 Test Database Connection</button>
    <button onclick="testQuery()">📊 Test Database Query</button>
    <button onclick="testInsert()">➕ Test Data Insert</button>
    
    <div id="results">
        <h3>Test Results:</h3>
        <div id="output"></div>
    </div>

    <!-- Include the bundled Neon client -->
    <script src="dist/neon-client.js"></script>
    
    <script>
        const config = {
            neonConnectionString: 'postgresql://neondb_owner:npg_L5ysD0JfHSFP@ep-curly-bird-91689233-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require'
        };

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        async function testConnection() {
            try {
                log('🔌 Testing Neon connection...', 'info');
                
                if (!window.neonClient) {
                    throw new Error('Neon client not loaded');
                }
                
                const sql = window.neonClient(config.neonConnectionString);
                log('✅ Neon client initialized', 'success');
                
                // Test a simple query
                const result = await sql`SELECT NOW() as current_time`;
                log(`✅ Connection successful! Current time: ${result[0].current_time}`, 'success');
                
                return true;
            } catch (error) {
                log(`❌ Connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testQuery() {
            try {
                log('📊 Testing database query...', 'info');
                
                const sql = window.neonClient(config.neonConnectionString);
                
                // Test querying the tables
                const tables = await sql`
                    SELECT table_name 
                    FROM information_schema.tables 
                    WHERE table_schema = 'public' 
                    AND table_name LIKE 'daily_david_entries%'
                `;
                
                log(`✅ Found ${tables.length} tables: ${tables.map(t => t.table_name).join(', ')}`, 'success');
                
                return true;
            } catch (error) {
                log(`❌ Query failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testInsert() {
            try {
                log('➕ Testing data insert...', 'info');
                
                const sql = window.neonClient(config.neonConnectionString);
                
                // Test inserting a sample entry
                const testData = {
                    scripture: "Psalm 23:1",
                    observation: "The Lord is my shepherd",
                    application: "Trust in God's guidance",
                    prayer: "Thank you for leading me"
                };
                
                const result = await sql`
                    INSERT INTO daily_david_entries_dev (date_key, user_id, data)
                    VALUES (${new Date().toISOString().split('T')[0]}, ${'test@example.com'}, ${JSON.stringify(testData)})
                    ON CONFLICT (date_key, user_id) DO NOTHING
                    RETURNING id
                `;
                
                if (result.length > 0) {
                    log(`✅ Data inserted successfully! ID: ${result[0].id}`, 'success');
                } else {
                    log('ℹ️ Data already exists (conflict resolved)', 'info');
                }
                
                return true;
            } catch (error) {
                log(`❌ Insert failed: ${error.message}`, 'error');
                return false;
            }
        }

        // Auto-test on page load
        window.addEventListener('load', async () => {
            log('🚀 Page loaded, testing Neon client...', 'info');
            
            if (window.neonClient) {
                log('✅ Neon client loaded successfully', 'success');
            } else {
                log('❌ Neon client not found', 'error');
            }
        });
    </script>
</body>
</html>
