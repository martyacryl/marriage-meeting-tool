<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Daily David - DEV (Spiritual Growth Tool)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#047857', // Slightly darker green for dev
                        secondary: '#10b981',
                        accent: '#34d399',
                    }
                }
            }
        }
    </script>
    <style>
        .section-divider {
            background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
            height: 1px;
            margin: 1.5rem 0;
        }
        .section-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 16px;
        }
        .section-header {
            background: linear-gradient(135deg, #94a3b8 0%, #059669 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        .status-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .modern-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid #cbd5e1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .soap-card {
            background: linear-gradient(135deg, #fefefe 0%, #f9fafb 100%);
            border: 2px solid #e5e7eb;
            box-shadow: 0 8px 25px -3px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-green-50 min-h-screen">
    <!-- Development Environment Banner -->
    <div class="bg-red-500 text-white text-center py-1 text-xs font-bold">
        🚧 DEV MODE - Testing Changes 🚧
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // Initialize Supabase - DEV ENVIRONMENT with Auth
        const supabaseUrl = 'https://gkmclzlgrcmqocfoxkui.supabase.co';
        
        // Choose your key type:
        // - anon key: Safe for users, limited admin functions
        // - service_role key: Full admin access (get from Supabase Dashboard → Settings → API)
        const USE_SERVICE_ROLE_KEY = true; // Set to true to enable admin functions
        
        const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrbWNsemxncmNtcW9jZm94a3VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDYzNzEsImV4cCI6MjA3MTE4MjM3MX0.ovOR0iMGao5qvrAThrx8KucLyTctiRkVbNJvYdPEyk0';
        
        // Add your service role key here (get from Supabase Dashboard → Settings → API)
        const serviceRoleKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdrbWNsemxncmNtcW9jZm94a3VpIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTYwNjM3MSwiZXhwIjoyMDcxMTgyMzcxfQ.Iz1__lQGZmxAiiMlildaypRObXBUzGu72DznKsGxTWk';
        
        const supabaseKey = USE_SERVICE_ROLE_KEY ? serviceRoleKey : anonKey;
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // DEV TABLE NAME - Separate from production
        const DEV_TABLE_NAME = 'daily_david_entries_dev';
        
        // Auth state
        let currentUser = null;
        let isAdmin = false;

        // Icons as SVG components
        const ChevronLeftIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
        );

        const ChevronRightIcon = () => (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
        );

        const PlusIcon = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        // Authentication Components
        const SignInScreen = ({ onSignIn, onAdminSignIn }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSignIn = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    // Check if user is admin (you can set this in user metadata)
                    const isUserAdmin = data.user?.user_metadata?.is_admin === true;
                    
                    if (isUserAdmin) {
                        onAdminSignIn(data.user);
                    } else {
                        onSignIn(data.user);
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-100 to-green-50">
                    <div className="modern-card p-8 w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center mb-8 text-primary">
                            The Daily David
                        </h1>
                        <p className="text-center text-gray-600 mb-6">Sign in to access your spiritual growth journey</p>
                        
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                                {error}
                            </div>
                        )}
                        
                        <form onSubmit={handleSignIn} className="space-y-4">
                            <input 
                                type="email" 
                                placeholder="Email" 
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                            />
                            <input 
                                type="password" 
                                placeholder="Password" 
                                className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                            />
                            <button 
                                type="submit"
                                disabled={loading}
                                className="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </form>
                        
                        <div className="mt-6 text-center">
                            <p className="text-sm text-gray-500">
                                Contact your administrator for access
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminPanel = ({ user, onSignOut, onAddUser, onRemoveUser, useServiceRoleKey }) => {
            const [users, setUsers] = useState([]);
            const [newUserEmail, setNewUserEmail] = useState('');
            const [newUserPassword, setNewUserPassword] = useState('');
            const [newUserDisplayName, setNewUserDisplayName] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                loadUsers();
            }, []);

            const loadUsers = async () => {
                try {
                    console.log('Loading users...');
                    
                    // Load real users from Supabase Auth
                    const { data, error } = await supabase.auth.admin.listUsers();
                    
                    if (error) {
                        console.error('Error loading users:', error);
                        alert('Error loading users: ' + error.message);
                        setUsers([]);
                        return;
                    }
                    
                    console.log('Users loaded:', data);
                    
                    if (!data || !data.users) {
                        console.log('No users data returned');
                        setUsers([]);
                        return;
                    }
                    
                    // Filter out the current admin user and format the data
                    const currentUserId = user?.id;
                    const filteredUsers = data.users
                        .filter(user => user.id !== currentUserId) // Don't show current admin user
                        .map(user => ({
                            id: user.id,
                            email: user.email,
                            display_name: user.user_metadata?.display_name || 'No Name',
                            created_at: user.created_at
                        }));
                    
                    console.log('Filtered users:', filteredUsers);
                    setUsers(filteredUsers);
                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('Error loading users: ' + error.message);
                    setUsers([]);
                }
            };

            const handleAddUser = async (e) => {
                e.preventDefault();
                if (!newUserEmail || !newUserPassword || !newUserDisplayName) return;

                setLoading(true);
                try {
                    // Create real user in Supabase Auth
                    const { data, error } = await supabase.auth.admin.createUser({
                        email: newUserEmail,
                        password: newUserPassword,
                        user_metadata: { display_name: newUserDisplayName },
                        email_confirm: true // Auto-confirm email for testing
                    });
                    
                    if (error) {
                        throw error;
                    }
                    
                    // Add to local users list
                    const newUser = {
                        id: data.user.id,
                        email: data.user.email,
                        display_name: newUserDisplayName,
                        created_at: data.user.created_at
                    };
                    
                    setUsers([...users, newUser]);
                    setNewUserEmail('');
                    setNewUserPassword('');
                    setNewUserDisplayName('');
                    
                    alert(`User ${newUserEmail} created successfully!`);
                    
                    // Refresh the users list to ensure sync
                    setTimeout(() => loadUsers(), 1000);
                } catch (error) {
                    alert('Error adding user: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-6xl">
                    <div className="flex justify-between items-center mb-8">
                        <h1 className="text-3xl font-bold text-gray-800">Admin Panel</h1>
                        <div className="flex items-center gap-3">
                            <button 
                                onClick={onSignOut}
                                className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600"
                            >
                                Sign Out
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* User Management */}
                        <div className="modern-card p-6">
                            <h2 className="text-2xl font-bold mb-4 text-primary">User Management</h2>
                            
                            {/* Service Role Key Notice - Only show if not configured */}
                            {!useServiceRoleKey && (
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                    <div className="flex items-center gap-2">
                                        <span className="text-yellow-800">⚠️</span>
                                        <div>
                                            <p className="text-yellow-800 font-medium">Admin Functions Setup Required</p>
                                            <p className="text-yellow-700 text-sm">
                                                To use admin functions (create/delete users), you need to:
                                            </p>
                                            <ol className="text-yellow-700 text-sm mt-2 list-decimal list-inside space-y-1">
                                                <li>Go to Supabase Dashboard → Settings → API</li>
                                                <li>Copy your "service_role" key</li>
                                                <li>Replace "YOUR_SERVICE_ROLE_KEY_HERE" in the code</li>
                                                <li>Set USE_SERVICE_ROLE_KEY = true</li>
                                            </ol>
                                            <p className="text-yellow-700 text-sm mt-2">
                                                <strong>Note:</strong> Service role keys have full database access - only use for development/testing.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* Success Message - Show when service role key is configured */}
                            {useServiceRoleKey && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                    <div className="flex items-center gap-2">
                                        <span className="text-green-800">✅</span>
                                        <div>
                                            <p className="text-green-800 font-medium">Admin Functions Enabled!</p>
                                            <p className="text-green-700 text-sm">
                                                Service role key is configured. You can now create, manage, and delete users through this panel.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            <form onSubmit={handleAddUser} className="space-y-4 mb-6">
                                <input 
                                    type="email" 
                                    placeholder="User Email" 
                                    className="w-full p-3 border rounded-lg"
                                    value={newUserEmail}
                                    onChange={(e) => setNewUserEmail(e.target.value)}
                                    required
                                />
                                <input 
                                    type="text" 
                                    placeholder="Display Name" 
                                    className="w-full p-3 border rounded-lg"
                                    value={newUserDisplayName}
                                    onChange={(e) => setNewUserDisplayName(e.target.value)}
                                    required
                                />
                                <input 
                                    type="password" 
                                    placeholder="Password" 
                                    className="w-full p-3 border rounded-lg"
                                    value={newUserPassword}
                                    onChange={(e) => setNewUserPassword(e.target.value)}
                                    required
                                />
                                <button 
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 disabled:opacity-50"
                                >
                                    {loading ? 'Adding User...' : 'Add User'}
                                </button>
                            </form>

                            <div className="space-y-2">
                                <div className="flex justify-between items-center">
                                    <h3 className="font-semibold">Current Users:</h3>
                                    <button 
                                        onClick={loadUsers}
                                        className="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600"
                                    >
                                        🔄 Refresh
                                    </button>
                                </div>
                                
                                {users.length === 0 ? (
                                    <div className="text-center py-4 text-gray-500">
                                        No users found. Click refresh to load users.
                                    </div>
                                ) : (
                                    users.map(user => (
                                        <div key={user.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <div>
                                                <div className="font-medium">{user.display_name}</div>
                                                <div className="text-sm text-gray-600">{user.email}</div>
                                            </div>
                                            <button 
                                                onClick={() => onRemoveUser(user.id)}
                                                className="text-red-500 hover:text-red-700"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* System Info */}
                        <div className="modern-card p-6">
                            <h2 className="text-2xl font-bold mb-4 text-primary">System Information</h2>
                            <div className="space-y-3">
                                <div>
                                    <span className="font-medium">Admin User:</span> {user.email}
                                </div>
                                    <span className="font-medium">Total Users:</span> {users.length}
                                <div>
                                    <span className="font-medium">Environment:</span> Development
                                </div>
                                <div>
                                    <span className="font-medium">Database:</span> {DEV_TABLE_NAME}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BookOpenIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
        );

        const HeartIcon = () => (
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
        );

        // Landing Page Component
        const LandingPage = ({ weeklyGoals, monthlyGoals, toggleGoal, addGoal, removeGoal, updateGoal, getWeeklyProgress, getMonthlyProgress, getDaysCompletedThisWeek, setCurrentView }) => {
            const [newGoalText, setNewGoalText] = useState('');
            const [newGoalCategory, setNewGoalCategory] = useState('spiritual');
            const [showAddGoal, setShowAddGoal] = useState(false);
            const [editingWeeklyGoal, setEditingWeeklyGoal] = useState(null);
            const [editingMonthlyGoal, setEditingMonthlyGoal] = useState(null);
            const [editWeeklyForm, setEditWeeklyForm] = useState({ text: '', category: 'spiritual' });
            const [editMonthlyForm, setEditMonthlyForm] = useState({ text: '', category: 'spiritual' });

            // Icon components for the landing page
            const TrashIcon = () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            );

            const weeklyProgress = getWeeklyProgress();
            const monthlyProgress = getMonthlyProgress();
            const daysCompleted = getDaysCompletedThisWeek();

            const handleAddGoal = (type) => {
                if (newGoalText.trim()) {
                    addGoal(type, newGoalText.trim(), newGoalCategory);
                    setNewGoalText('');
                    setShowAddGoal(false);
                }
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-6xl">
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-gray-800 mb-2">
                            Welcome to Your Spiritual Journey
                        </h1>
                        <p className="text-gray-600">Track your progress and stay focused on your goals</p>
                        
                        {/* Quick Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <div className="bg-white p-4 rounded-lg shadow-md">
                                <div className="text-2xl font-bold text-primary">{daysCompleted}/7</div>
                                <div className="text-sm text-gray-600">Days This Week</div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow-md">
                                <div className="text-2xl font-bold text-primary">{weeklyProgress.percentage}%</div>
                                <div className="text-sm text-gray-600">Weekly Goals</div>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow-md">
                                <div className="text-2xl font-bold text-primary">{monthlyProgress.percentage}%</div>
                                <div className="text-sm text-gray-600">Monthly Goals</div>
                            </div>
                        </div>
                    </div>

                    {/* Weekly Goals Section */}
                    <div className="modern-card p-6 mb-8">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-semibold text-gray-800">Weekly Goals</h2>
                            <button
                                onClick={() => setShowAddGoal('weekly')}
                                className="bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors"
                            >
                                Add Goal
                            </button>
                        </div>
                        
                        {/* Progress Bar */}
                        <div className="mb-4">
                            <div className="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Progress</span>
                                <span>{weeklyProgress.completed}/{weeklyProgress.total}</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div 
                                    className="bg-primary h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${weeklyProgress.percentage}%` }}
                                ></div>
                            </div>
                        </div>

                        {/* Goals List */}
                        <div className="space-y-3">
                            {weeklyGoals.map(goal => (
                                <div key={goal.id} className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg group">
                                    <button
                                        onClick={() => toggleGoal('weekly', goal.id)}
                                        className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${
                                            goal.completed 
                                                ? 'bg-primary border-primary text-white' 
                                                : 'border-gray-300 hover:border-primary'
                                        }`}
                                    >
                                        {goal.completed && '✓'}
                                    </button>
                                    {editingWeeklyGoal === goal.id ? (
                                        // Edit Mode
                                        <div className="flex-1 flex space-x-2">
                                            <input
                                                type="text"
                                                value={editWeeklyForm.text}
                                                onChange={(e) => setEditWeeklyForm(prev => ({ ...prev, text: e.target.value }))}
                                                className="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary"
                                                placeholder="Enter goal text..."
                                            />
                                            <select
                                                value={editWeeklyForm.category}
                                                onChange={(e) => setEditWeeklyForm(prev => ({ ...prev, category: e.target.value }))}
                                                className="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary"
                                            >
                                                <option value="spiritual">Spiritual</option>
                                                <option value="personal">Personal</option>
                                                <option value="outreach">Outreach</option>
                                                <option value="health">Health</option>
                                                <option value="work">Work</option>
                                            </select>
                                            <button
                                                onClick={() => {
                                                    updateGoal('weekly', goal.id, editWeeklyForm.text, editWeeklyForm.category);
                                                    setEditingWeeklyGoal(null);
                                                    setEditWeeklyForm({ text: '', category: 'spiritual' });
                                                }}
                                                className="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                                            >
                                                Save
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setEditingWeeklyGoal(null);
                                                    setEditWeeklyForm({ text: '', category: 'spiritual' });
                                                }}
                                                className="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    ) : (
                                        // Display Mode
                                        <>
                                            <span className={`flex-1 ${goal.completed ? 'line-through text-gray-500' : ''}`}>
                                                {goal.text}
                                            </span>
                                            <span className={`px-2 py-1 text-xs rounded-full ${
                                                goal.category === 'spiritual' ? 'bg-blue-100 text-blue-800' :
                                                goal.category === 'personal' ? 'bg-green-100 text-green-800' :
                                                'bg-purple-100 text-purple-800'
                                            }`}>
                                                {goal.category}
                                            </span>
                                        </>
                                    )}
                                    <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => {
                                                setEditingWeeklyGoal(goal.id);
                                                setEditWeeklyForm({ text: goal.text, category: goal.category || 'spiritual' });
                                            }}
                                            className="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-50"
                                            title="Edit goal"
                                        >
                                            ✏️
                                        </button>
                                        <button
                                            onClick={() => removeGoal('weekly', goal.id)}
                                            className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50"
                                            title="Remove goal"
                                        >
                                            <TrashIcon />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Add Goal Form */}
                        {showAddGoal === 'weekly' && (
                            <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                <div className="flex space-x-2">
                                    <input
                                        type="text"
                                        value={newGoalText}
                                        onChange={(e) => setNewGoalText(e.target.value)}
                                        placeholder="Enter your weekly goal..."
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                    />
                                    <select
                                        value={newGoalCategory}
                                        onChange={(e) => setNewGoalCategory(e.target.value)}
                                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                    >
                                        <option value="spiritual">Spiritual</option>
                                        <option value="personal">Personal</option>
                                        <option value="outreach">Outreach</option>
                                    </select>
                                    <button
                                        onClick={() => handleAddGoal('weekly')}
                                        className="bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => setShowAddGoal(false)}
                                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Monthly Goals Section */}
                    <div className="modern-card p-6 mb-8">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-semibold text-gray-800">Monthly Goals</h2>
                            <button
                                onClick={() => setShowAddGoal('monthly')}
                                className="bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors"
                            >
                                Add Goal
                            </button>
                        </div>
                        
                        {/* Progress Bar */}
                        <div className="mb-4">
                            <div className="flex justify-between text-sm text-gray-600 mb-1">
                                <span>Progress</span>
                                <span>{monthlyProgress.completed}/{monthlyProgress.total}</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div 
                                    className="bg-primary h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${monthlyProgress.percentage}%` }}
                                ></div>
                            </div>
                        </div>

                        {/* Goals List */}
                        <div className="space-y-3">
                            {monthlyGoals.map(goal => (
                                <div key={goal.id} className="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg group">
                                    <button
                                        onClick={() => toggleGoal('monthly', goal.id)}
                                        className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-colors ${
                                            goal.completed 
                                                ? 'bg-primary border-primary text-white' 
                                                : 'border-gray-300 hover:border-primary'
                                        }`}
                                    >
                                        {goal.completed && '✓'}
                                    </button>
                                    {editingMonthlyGoal === goal.id ? (
                                        // Edit Mode
                                        <div className="flex-1 flex space-x-2">
                                            <input
                                                type="text"
                                                value={editMonthlyForm.text}
                                                onChange={(e) => setEditMonthlyForm(prev => ({ ...prev, text: e.target.value }))}
                                                className="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary"
                                                placeholder="Enter goal text..."
                                            />
                                            <select
                                                value={editMonthlyForm.category}
                                                onChange={(e) => setEditMonthlyForm(prev => ({ ...prev, category: e.target.value }))}
                                                className="px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary"
                                            >
                                                <option value="spiritual">Spiritual</option>
                                                <option value="personal">Personal</option>
                                                <option value="outreach">Outreach</option>
                                                <option value="health">Health</option>
                                                <option value="work">Work</option>
                                            </select>
                                            <button
                                                onClick={() => {
                                                    updateGoal('monthly', goal.id, editMonthlyForm.text, editMonthlyForm.category);
                                                    setEditingMonthlyGoal(null);
                                                    setEditMonthlyForm({ text: '', category: 'spiritual' });
                                                }}
                                                className="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                                            >
                                                Save
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setEditingMonthlyGoal(null);
                                                    setEditMonthlyForm({ text: '', category: 'spiritual' });
                                                }}
                                                className="px-2 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    ) : (
                                        // Display Mode
                                        <>
                                            <span className={`flex-1 ${goal.completed ? 'line-through text-gray-500' : ''}`}>
                                                {goal.text}
                                            </span>
                                            <span className={`px-2 py-1 text-xs rounded-full ${
                                                goal.category === 'spiritual' ? 'bg-blue-100 text-blue-800' :
                                                goal.category === 'personal' ? 'bg-green-100 text-green-800' :
                                                'bg-purple-100 text-purple-800'
                                            }`}>
                                                {goal.category}
                                            </span>
                                        </>
                                    )}
                                    <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => {
                                                setEditingMonthlyGoal(goal.id);
                                                setEditMonthlyForm({ text: goal.text, category: goal.category || 'spiritual' });
                                            }}
                                            className="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-50"
                                            title="Edit goal"
                                            >
                                            ✏️
                                        </button>
                                        <button
                                            onClick={() => removeGoal('monthly', goal.id)}
                                            className="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50"
                                            title="Remove goal"
                                        >
                                            <TrashIcon />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Add Goal Form */}
                        {showAddGoal === 'monthly' && (
                            <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                <div className="flex space-x-2">
                                    <input
                                        type="text"
                                        value={newGoalText}
                                        onChange={(e) => setNewGoalText(e.target.value)}
                                        placeholder="Enter your monthly goal..."
                                        className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                    />
                                    <select
                                        value={newGoalCategory}
                                        onChange={(e) => setNewGoalCategory(e.target.value)}
                                        className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
                                    >
                                        <option value="spiritual">Spiritual</option>
                                        <option value="personal">Personal</option>
                                        <option value="outreach">Outreach</option>
                                    </select>
                                    <button
                                        onClick={() => handleAddGoal('monthly')}
                                        className="bg-primary hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => setShowAddGoal(false)}
                                        className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Action Buttons */}
                    <div className="text-center">
                        <button
                            onClick={() => setCurrentView('daily')}
                            className="bg-primary hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all duration-300"
                        >
                            Start Today's Entry
                        </button>
                    </div>
                </div>
            );
        };

        const DailyDavidApp = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [dayData, setDayData] = useState({});
            const [isConnected, setIsConnected] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [lastSaved, setLastSaved] = useState(null);
            const [currentView, setCurrentView] = useState('landing'); // 'landing' or 'daily'
            // Goals are now stored in userSpecificData and loaded per user
            const saveTimeoutRef = useRef(null);
            
            // Authentication state
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [authLoading, setAuthLoading] = useState(true);
            
            // Mode preference state (persists across refreshes)
            const [userModePreference, setUserModePreference] = useState('admin'); // 'admin' or 'user'
            
            // User-specific data state (isolated per user)
            const [userSpecificData, setUserSpecificData] = useState({
                dayData: {},
                weeklyGoals: [],
                monthlyGoals: []
            });

            // DEBUG: Wrap setUserSpecificData to track all calls
            const debugSetUserSpecificData = (newData) => {
                console.log('🔍 DEBUG: setUserSpecificData called with:', newData);
                console.log('🔍 DEBUG: Previous state was:', userSpecificData);
                console.log('🔍 DEBUG: Stack trace for this call:');
                console.trace('setUserSpecificData call stack trace');
                
                if (typeof newData === 'function') {
                    console.log('🔍 DEBUG: This is a function update, will call it with current state');
                    const result = newData(userSpecificData);
                    console.log('🔍 DEBUG: Function returned:', result);
                    setUserSpecificData(result);
                } else {
                    console.log('🔍 DEBUG: This is a direct value update');
                    setUserSpecificData(newData);
                }
            };

            const formatDateKey = (date) => {
                return date.toISOString().split('T')[0];
            };

            const formatDateDisplay = (date) => {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            };

            // Load day data from database and localStorage
            const loadDayData = async (dateKey) => {
                if (!user) return null;
                
                // First try to load from localStorage
                const localStorageKey = `dailyDavid_dayData_${user.id}`;
                try {
                    const localStorageData = localStorage.getItem(localStorageKey);
                    if (localStorageData) {
                        const parsedData = JSON.parse(localStorageData);
                        if (parsedData[dateKey]) {
                            console.log('Loaded day data from localStorage for date:', dateKey);
                            return parsedData[dateKey];
                        }
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
                
                // If no localStorage data, try database
                console.log('No localStorage data, trying database for date:', dateKey);
                try {
                    const { data, error } = await supabase
                        .from(DEV_TABLE_NAME)
                        .select('*')
                        .eq('date_key', dateKey)
                        .eq('user_id', user.id);

                    if (error) {
                        console.log('Error loading from database:', error);
                        return null;
                    }

                    if (data && data.length > 0) {
                        console.log('Loaded day data from database for date:', dateKey);
                        // Also save to localStorage for future use
                        try {
                            const existingData = localStorage.getItem(localStorageKey);
                            const parsedData = existingData ? JSON.parse(existingData) : {};
                            parsedData[dateKey] = data[0].data;
                            localStorage.setItem(localStorageKey, JSON.stringify(parsedData));
                            console.log('Day data also saved to localStorage');
                        } catch (localError) {
                            console.error('Error saving to localStorage:', localError);
                        }
                        return data[0].data;
                    }

                    return null;
                } catch (error) {
                    console.log('Load error from database:', error);
                    return null;
                }
            };

            // Save day data to database and localStorage - AGGRESSIVE localStorage backup
            const saveDayData = async (dateKey, data) => {
                if (!user) return false;
                
                // DEBUG: Log what data is being saved
                console.log('💾 DEBUG: saveDayData called with:');
                console.log('💾 DEBUG: dateKey:', dateKey);
                console.log('💾 DEBUG: data:', data);
                console.log('💾 DEBUG: data.gratitude:', data?.gratitude);
                console.log('💾 DEBUG: data.soap:', data?.soap);
                console.log('💾 DEBUG: data.gratitude.length:', data?.gratitude?.length);
                console.log('💾 DEBUG: data.gratitude[0]:', data?.gratitude?.[0]);
                console.log('💾 DEBUG: data.gratitude[1]:', data?.gratitude?.[1]);
                console.log('💾 DEBUG: data.soap.scripture:', data?.soap?.scripture);
                
                // AGGRESSIVE: Save to localStorage MULTIPLE times with multiple keys
                const localStorageKey = `dailyDavid_dayData_${user.id}`;
                const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                
                try {
                    const existingData = localStorage.getItem(localStorageKey);
                    const parsedData = existingData ? JSON.parse(existingData) : {};
                    parsedData[dateKey] = data;
                    
                    // DEBUG: Log what's being saved to localStorage
                    console.log('💾 DEBUG: Saving to localStorage:');
                    console.log('💾 DEBUG: parsedData[dateKey]:', parsedData[dateKey]);
                    console.log('💾 DEBUG: parsedData[dateKey].gratitude:', parsedData[dateKey]?.gratitude);
                    console.log('💾 DEBUG: parsedData[dateKey].soap:', parsedData[dateKey]?.soap);
                    
                    // Save to primary key
                    localStorage.setItem(localStorageKey, JSON.stringify(parsedData));
                    console.log('💾 AGGRESSIVE: Day data saved to localStorage (primary):', dateKey);
                    
                    // Save to backup key
                    localStorage.setItem(backupKey, JSON.stringify(parsedData));
                    console.log('💾 AGGRESSIVE: Day data saved to backup localStorage:', dateKey);
                    
                    // Save to emergency key
                    localStorage.setItem(emergencyKey, JSON.stringify(parsedData));
                    console.log('💾 AGGRESSIVE: Day data saved to emergency localStorage:', dateKey);
                    
                    // Save again after a tiny delay
                    setTimeout(() => {
                        try {
                            localStorage.setItem(localStorageKey, JSON.stringify(parsedData));
                            localStorage.setItem(backupKey, JSON.stringify(parsedData));
                            console.log('💾 AGGRESSIVE: Day data saved again (delayed):', dateKey);
                        } catch (error) {
                            console.error('❌ Error in delayed save:', error);
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
                
                try {
                    const { error } = await supabase
                        .from(DEV_TABLE_NAME)
                        .upsert({
                            date_key: dateKey,
                            user_id: user.id,
                            data: data
                        }, {
                            onConflict: 'date_key,user_id'
                        });

                    if (error) {
                        console.log('Save error:', error);
                        console.log('Day data saved to localStorage as backup');
                        return false;
                    }

                    setLastSaved(new Date());
                    console.log('Day data saved successfully to database');
                    return true;
                } catch (error) {
                    console.log('Save error:', error);
                    console.log('Day data saved to localStorage as backup');
                    return false;
                }
            };

            // Debounced save - waits 1 second after typing stops
            const debouncedSave = useCallback((dateKey, data) => {
                console.log('⏰ DEBUG: debouncedSave called with:');
                console.log('⏰ DEBUG: dateKey:', dateKey);
                console.log('⏰ DEBUG: data:', data);
                console.log('⏰ DEBUG: data.gratitude:', data?.gratitude);
                console.log('⏰ DEBUG: data.soap:', data?.soap);
                
                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }
                saveTimeoutRef.current = setTimeout(() => {
                    console.log('⏰ DEBUG: debouncedSave timeout fired, calling saveDayData');
                    saveDayData(dateKey, data);
                }, 1000);
            }, []);

            // Initialize database connection
            const initializeDatabase = async () => {
                setIsConnected(true);
            };

            // Function to clear user data when switching between different users
            const clearUserData = () => {
                console.log('🚨 CLEARING USER DATA - switching to different user');
                console.trace('clearUserData called from:'); // This will show the call stack
                setUserSpecificData({
                    dayData: {},
                    weeklyGoals: [],
                    monthlyGoals: []
                });
                setCurrentView('landing');
                setCurrentDate(new Date());
            };

            // Function to save goals to database and localStorage
            const saveGoals = async (weeklyGoals, monthlyGoals) => {
                if (!user) {
                    console.log('No user, cannot save goals');
                    return false;
                }
                
                // Always save to localStorage as backup
                const localStorageKey = `dailyDavid_goals_${user.id}`;
                const goalsData = {
                    weeklyGoals: weeklyGoals,
                    monthlyGoals: monthlyGoals,
                    lastUpdated: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem(localStorageKey, JSON.stringify(goalsData));
                    console.log('Goals saved to localStorage:', goalsData);
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
                
                try {
                    console.log('Saving goals to database:', { weeklyGoals, monthlyGoals, userId: user.id });
                    
                    const { data, error } = await supabase
                        .from(DEV_TABLE_NAME)
                        .upsert({
                            date_key: 'user_goals',
                            user_id: user.id,
                            data: goalsData
                        }, {
                            onConflict: 'date_key,user_id'
                        });

                    if (error) {
                        console.error('Save goals error:', error);
                        console.log('Goals saved to localStorage as backup');
                        return false;
                    }

                    console.log('Goals saved successfully to database:', data);
                    return true;
                } catch (error) {
                    console.error('Save goals exception:', error);
                    console.log('Goals saved to localStorage as backup');
                    return false;
                }
            };

                        // Function to load user-specific data - BULLETPROOF localStorage approach
            const loadUserSpecificData = async (userId) => {
                try {
                    console.log('🔄 BULLETPROOF: Loading user-specific data for:', userId);
                    
                    // DIRECT localStorage access - no complex logic
                    const goalsKey = `dailyDavid_goals_${userId}`;
                    const dayDataKey = `dailyDavid_dayData_${userId}`;
                    
                    console.log('🔑 Goals key:', goalsKey);
                    console.log('🔑 Day data key:', dayDataKey);
                    
                    // Load goals directly from localStorage
                    let weeklyGoals = [];
                    let monthlyGoals = [];
                    let dayData = {};
                    
                    try {
                        const goalsData = localStorage.getItem(goalsKey);
                        if (goalsData) {
                            const parsed = JSON.parse(goalsData);
                            weeklyGoals = parsed.weeklyGoals || [];
                            monthlyGoals = parsed.monthlyGoals || [];
                            console.log('✅ Goals loaded from localStorage:', { weeklyGoals, monthlyGoals });
                        } else {
                            console.log('⚠️ No goals in localStorage, using defaults');
                            weeklyGoals = [
                                { id: 1, text: 'Complete 5 SOAP studies this week', completed: false, category: 'spiritual' },
                                { id: 2, text: 'Practice gratitude daily', completed: false, category: 'personal' },
                                { id: 3, text: 'Read 3 chapters of scripture', completed: false, category: 'spiritual' }
                            ];
                            monthlyGoals = [
                                { id: 1, text: 'Establish daily prayer routine', completed: false, category: 'spiritual' },
                                { id: 2, text: 'Complete 20 SOAP studies', completed: false, category: 'spiritual' },
                                { id: 3, text: 'Share faith with 2 people', completed: false, category: 'outreach' }
                            ];
                        }
                    } catch (error) {
                        console.error('❌ Error loading goals from localStorage:', error);
                        // Use defaults on error
                        weeklyGoals = [
                            { id: 1, text: 'Complete 5 SOAP studies this week', completed: false, category: 'spiritual' },
                            { id: 2, text: 'Practice gratitude daily', completed: false, category: 'personal' },
                            { id: 3, text: 'Read 3 chapters of scripture', completed: false, category: 'spiritual' }
                        ];
                        monthlyGoals = [
                            { id: 1, text: 'Establish daily prayer routine', completed: false, category: 'spiritual' },
                            { id: 2, text: 'Complete 20 SOAP studies', completed: false, category: 'spiritual' },
                            { id: 3, text: 'Share faith with 2 people', completed: false, category: 'outreach' }
                        ];
                    }
                    
                    // Load day data directly from localStorage
                    try {
                        const dayDataRaw = localStorage.getItem(dayDataKey);
                        if (dayDataRaw) {
                            dayData = JSON.parse(dayDataRaw);
                            console.log('✅ Day data loaded from localStorage:', Object.keys(dayData).length, 'dates');
                            console.log('📅 Date keys:', Object.keys(dayData));
                        } else {
                            console.log('⚠️ No day data in localStorage, starting fresh');
                            dayData = {};
                        }
                    } catch (error) {
                        console.error('❌ Error loading day data from localStorage:', error);
                        dayData = {};
                    }
                    
                    // FORCE update the state with what we loaded
                    console.log('🔄 FORCING state update with loaded data');
                    console.log('📊 Day data to set:', dayData);
                    console.log('📊 Weekly goals to set:', weeklyGoals);
                    console.log('📊 Monthly goals to set:', monthlyGoals);
                    
                    setUserSpecificData({
                        dayData: dayData,
                        weeklyGoals: weeklyGoals,
                        monthlyGoals: monthlyGoals
                    });
                    
                    console.log('✅ BULLETPROOF: User-specific data loaded and state updated');
                    
                } catch (error) {
                    console.error('❌ CRITICAL ERROR in loadUserSpecificData:', error);
                    // Emergency fallback
                    setUserSpecificData({
                        dayData: {},
                        weeklyGoals: [
                            { id: 1, text: 'Complete 5 SOAP studies this week', completed: false, category: 'spiritual' },
                            { id: 2, text: 'Practice gratitude daily', completed: false, category: 'personal' },
                            { id: 3, text: 'Read 3 chapters of scripture', completed: false, category: 'spiritual' }
                        ],
                        monthlyGoals: [
                            { id: 1, text: 'Establish daily prayer routine', completed: false, category: 'spiritual' },
                            { id: 2, text: 'Complete 20 SOAP studies', completed: false, category: 'spiritual' },
                            { id: 3, text: 'Share faith with 2 people', completed: false, category: 'outreach' }
                        ]
                    });
                }
            };

            // Authentication handlers - Simplified approach
            const handleSignIn = async (userData) => {
                console.log('🔐 User signing in:', userData.email);
                
                // ALWAYS load user data from localStorage first, regardless of same user or not
                console.log('🔄 Loading user-specific data from localStorage...');
                await loadUserSpecificData(userData.id);
                
                // Set user state after loading data
                setUser(userData);
                setIsAdmin(false); // Regular users are never admin
                
                console.log('✅ User sign-in complete, data loaded from localStorage');
            };

            const handleAdminSignIn = async (userData) => {
                console.log('👑 Admin signing in:', userData.email);
                
                // Admin users only get admin functionality
                setUser(userData);
                setIsAdmin(true);
                setUserModePreference('admin');
                
                // Don't load user-specific data for admin users
                // They only manage other users
            };

            // Remove the mode switching function - no longer needed

            const handleSignOut = async () => {
                try {
                    console.log('User signing out');
                    // Don't clear user data on sign out - it's already saved to localStorage
                    // Just clear the user state
                    await supabase.auth.signOut();
                    setUser(null);
                    setIsAdmin(false);
                    // Note: We don't call clearUserData() here to preserve localStorage data
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            };

            const handleAddUser = async (email, password, displayName) => {
                // This would use Supabase admin functions in production
                // For now, just show a success message
                alert(`User ${email} would be created with admin privileges. In production, this would use Supabase admin API.`);
            };

            const handleRemoveUser = async (userId) => {
                if (!confirm('Are you sure you want to remove this user? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    console.log('Attempting to remove user:', userId);
                    
                    // First, verify the user exists in Supabase
                    const { data: userData, error: userError } = await supabase.auth.admin.getUserById(userId);
                    
                    if (userError) {
                        console.error('User lookup error:', userError);
                        if (userError.message.includes('not found')) {
                            // User doesn't exist in Supabase, just remove from local list
                            console.log('User not found in Supabase, removing from local list only');
                            const updatedUsers = users.filter(u => u.id !== userId);
                            setUsers(updatedUsers);
                            alert('User was not found in the system and has been removed from the list.');
                            return;
                        }
                        throw userError;
                    }
                    
                    if (!userData || !userData.user) {
                        console.log('No user data returned, removing from local list only');
                        const updatedUsers = users.filter(u => u.id !== userId);
                        setUsers(updatedUsers);
                        alert('User data not found, removed from local list.');
                        return;
                    }
                    
                    console.log('User found in Supabase:', userData.user.email);
                    
                    // Now delete the user from Supabase Auth
                    const { error: deleteError } = await supabase.auth.admin.deleteUser(userId);
                    
                    if (deleteError) {
                        console.error('Supabase delete user error:', deleteError);
                        throw deleteError;
                    }
                    
                    console.log('User deleted successfully from Supabase');
                    
                    // Remove from local users list
                    const updatedUsers = users.filter(u => u.id !== userId);
                    setUsers(updatedUsers);
                    console.log('Updated local users list:', updatedUsers);
                    
                    alert('User removed successfully!');
                } catch (error) {
                    console.error('Remove user error details:', error);
                    console.error('Error message:', error.message);
                    console.error('Error code:', error.status);
                    console.error('Error details:', error.details);
                    
                    let errorMessage = 'Error removing user';
                    if (error.message) {
                        errorMessage += ': ' + error.message;
                    } else if (error.error_description) {
                        errorMessage += ': ' + error.error_description;
                    } else if (error.status) {
                        errorMessage += ` (Status: ${error.status})`;
                    }
                    
                    alert(errorMessage);
                }
            };

            const handleSwitchToUserMode = async () => {
                await switchAdminToUserMode();
            };

            // Goal management functions
            const toggleGoal = async (goalType, goalId) => {
                if (goalType === 'weekly') {
                    setUserSpecificData(prev => {
                        const newWeeklyGoals = prev.weeklyGoals.map(goal => 
                            goal.id === goalId ? { ...goal, completed: !goal.completed } : goal
                        );
                        // Save to database
                        saveGoals(newWeeklyGoals, prev.monthlyGoals);
                        return {
                            ...prev,
                            weeklyGoals: newWeeklyGoals
                        };
                    });
                } else {
                    setUserSpecificData(prev => {
                        const newMonthlyGoals = prev.monthlyGoals.map(goal => 
                            goal.id === goalId ? { ...goal, completed: !goal.completed } : goal
                        );
                        // Save to database
                        saveGoals(prev.weeklyGoals, newMonthlyGoals);
                        return {
                            ...prev,
                            monthlyGoals: newMonthlyGoals
                        };
                    });
                }
            };

            const addGoal = async (goalType, text, category) => {
                const newGoal = {
                    id: Date.now(),
                    text,
                    completed: false,
                    category
                };
                
                if (goalType === 'weekly') {
                    setUserSpecificData(prev => {
                        const newWeeklyGoals = [...prev.weeklyGoals, newGoal];
                        // Save to database
                        saveGoals(newWeeklyGoals, prev.monthlyGoals);
                        return {
                            ...prev,
                            weeklyGoals: newWeeklyGoals
                        };
                    });
                } else {
                    setUserSpecificData(prev => {
                        const newMonthlyGoals = [...prev.monthlyGoals, newGoal];
                        // Save to database
                        saveGoals(prev.weeklyGoals, newMonthlyGoals);
                        return {
                            ...prev,
                            monthlyGoals: newMonthlyGoals
                        };
                    });
                }
            };

            const removeGoal = async (goalType, goalId) => {
                if (goalType === 'weekly') {
                    setUserSpecificData(prev => {
                        const newWeeklyGoals = prev.weeklyGoals.filter(goal => goal.id !== goalId);
                        // Save to database
                        saveGoals(newWeeklyGoals, prev.monthlyGoals);
                        return {
                            ...prev,
                            weeklyGoals: newWeeklyGoals
                        };
                    });
                } else {
                    setUserSpecificData(prev => {
                        const newMonthlyGoals = prev.monthlyGoals.filter(goal => goal.id !== goalId);
                        // Save to database
                        saveGoals(prev.weeklyGoals, newMonthlyGoals);
                        return {
                            ...prev,
                            monthlyGoals: newMonthlyGoals
                        };
                    });
                }
            };

            const updateGoal = async (goalType, goalId, newText, newCategory) => {
                if (goalType === 'weekly') {
                    setUserSpecificData(prev => {
                        const newWeeklyGoals = prev.weeklyGoals.map(goal => 
                            goal.id === goalId ? { ...goal, text: newText, category: newCategory } : goal
                        );
                        // Save to database
                        saveGoals(newWeeklyGoals, prev.monthlyGoals);
                        return {
                            ...prev,
                            weeklyGoals: newWeeklyGoals
                        };
                    });
                } else {
                    setUserSpecificData(prev => {
                        const newMonthlyGoals = prev.monthlyGoals.map(goal => 
                            goal.id === goalId ? { ...goal, text: newText, category: newCategory } : goal
                        );
                        // Save to database
                        saveGoals(prev.weeklyGoals, newMonthlyGoals);
                        return {
                            ...prev,
                            monthlyGoals: newMonthlyGoals
                        };
                    });
                }
            };

            // Progress calculation functions
            const getWeeklyProgress = () => {
                const completed = userSpecificData.weeklyGoals.filter(goal => goal.completed).length;
                return { completed, total: userSpecificData.weeklyGoals.length, percentage: Math.round((completed / userSpecificData.weeklyGoals.length) * 100) };
            };

            const getMonthlyProgress = () => {
                const completed = userSpecificData.monthlyGoals.filter(goal => goal.completed).length;
                return { completed, total: userSpecificData.monthlyGoals.length, percentage: Math.round((completed / userSpecificData.monthlyGoals.length) * 100) };
            };

            const getDaysCompletedThisWeek = () => {
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
                const endOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 6));
                
                let completedDays = 0;
                for (let d = new Date(startOfWeek); d <= endOfWeek; d.setDate(d.getDate() + 1)) {
                    const dateKey = formatDateKey(d);
                    if (userSpecificData.dayData[dateKey]) {
                        completedDays++;
                    }
                }
                return completedDays;
            };

            // Goal management functions for daily entry view
            const addDailyGoal = (goalType) => {
                const newGoal = {
                    id: Date.now(),
                    text: '',
                    completed: false
                };
                
                const updatedDayData = { ...currentDayData };
                if (!updatedDayData.goals) updatedDayData.goals = {};
                if (!updatedDayData.goals[goalType]) updatedDayData.goals[goalType] = [];
                
                updatedDayData.goals[goalType].push(newGoal);
                setUserSpecificData(prev => ({ ...prev, dayData: { ...prev.dayData, [formatDateKey(currentDate)]: updatedDayData } }));
                debouncedSave(formatDateKey(currentDate), updatedDayData);
            };

            const updateDailyGoal = (goalType, goalId, newText) => {
                const updatedDayData = { ...currentDayData };
                const goalIndex = updatedDayData.goals[goalType].findIndex(g => g.id === goalId);
                if (goalIndex !== -1) {
                    updatedDayData.goals[goalType][goalIndex].text = newText;
                    setUserSpecificData(prev => ({ ...prev, dayData: { ...prev.dayData, [formatDateKey(currentDate)]: updatedDayData } }));
                    debouncedSave(formatDateKey(currentDate), updatedDayData);
                }
            };

            const toggleDailyGoal = (goalType, goalId) => {
                const updatedDayData = { ...currentDayData };
                const goalIndex = updatedDayData.goals[goalType].findIndex(g => g.id === goalId);
                if (goalIndex !== -1) {
                    updatedDayData.goals[goalType][goalIndex].completed = !updatedDayData.goals[goalType][goalIndex].completed;
                    setUserSpecificData(prev => ({ ...prev, dayData: { ...prev.dayData, [formatDateKey(currentDate)]: updatedDayData } }));
                    debouncedSave(formatDateKey(currentDate), updatedDayData);
                }
            };

            const removeDailyGoal = (goalType, goalId) => {
                const updatedDayData = { ...currentDayData };
                updatedDayData.goals[goalType] = updatedDayData.goals[goalType].filter(g => g.id !== goalId);
                setUserSpecificData(prev => ({ ...prev, dayData: { ...prev.dayData, [formatDateKey(currentDate)]: updatedDayData } }));
                debouncedSave(formatDateKey(currentDate), updatedDayData);
            };

            // Initialize day data
            const initializeDayData = useCallback(async () => {
                const dateKey = formatDateKey(currentDate);
                
                if (userSpecificData.dayData[dateKey]) {
                    return userSpecificData.dayData[dateKey];
                }

                setIsLoading(true);
                
                const savedData = await loadDayData(dateKey);
                
                if (savedData) {
                    setUserSpecificData(prev => ({ 
                        ...prev, 
                        dayData: { ...prev.dayData, [dateKey]: savedData } 
                    }));
                    setIsLoading(false);
                    return savedData;
                }

                const newDayData = {
                    gratitude: ['', '', '', '', ''],
                    soap: {
                        scripture: '',
                        observation: '',
                        application: '',
                        prayer: ''
                    },
                    goals: {
                        daily: [],
                        weekly: [],
                        monthly: []
                    }
                };

                setUserSpecificData(prev => ({ 
                    ...prev, 
                    dayData: { ...prev.dayData, [dateKey]: newDayData } 
                }));
                await saveDayData(dateKey, newDayData);
                setIsLoading(false);
                return newDayData;
            }, [currentDate, userSpecificData.dayData]);

            // Initialize on mount
            useEffect(() => {
                initializeDatabase().then(() => {
                    initializeDayData();
                });
            }, [initializeDayData]);

            // Initialize authentication
            useEffect(() => {
                const initializeAuth = async () => {
                    try {
                        console.log('🔐 Initializing authentication...');
                        
                        // Debug: Check localStorage state before auth
                        console.log('📋 localStorage state before auth:');
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('dailyDavid_')) {
                                console.log('  ', key, ':', localStorage.getItem(key)?.substring(0, 100) + '...');
                            }
                        }
                        
                        // Get current user session
                        const { data: { user }, error } = await supabase.auth.getUser();
                        
                        if (error) {
                            console.error('❌ Error getting user:', error);
                            setAuthLoading(false);
                            return;
                        }
                        
                        if (user) {
                            console.log('✅ User found:', user.email);
                            setUser(user);
                            // Check if user is admin (you can set this in user metadata)
                            const isUserAdmin = user.user_metadata?.is_admin === true;
                            setIsAdmin(isUserAdmin);
                            
                            // Load saved mode preference for admin users
                            if (isUserAdmin) {
                                const savedMode = localStorage.getItem('dailyDavidMode');
                                if (savedMode === 'user') {
                                    setUserModePreference('user');
                                    setIsAdmin(false);
                                    // Load user-specific data for user mode
                                    console.log('🔄 Loading user-specific data for admin in user mode...');
                                    await loadUserSpecificData(user.id);
                                } else {
                                    setUserModePreference('admin');
                                    setIsAdmin(true);
                                }
                            } else {
                                // Regular user, load their data
                                console.log('🔄 Loading user-specific data for regular user...');
                                await loadUserSpecificData(user.id);
                            }
                        } else {
                            console.log('⚠️ No user session found');
                        }
                    } catch (error) {
                        console.error('❌ Auth initialization error:', error);
                    } finally {
                        console.log('✅ Setting auth loading to false');
                        setAuthLoading(false);
                    }
                };

                // Listen for auth changes - Simplified approach
                const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session?.user) {
                        console.log('🔄 Auth state change: SIGNED_IN for user:', session.user.email);
                        
                        // Only handle auth state changes if we don't already have a user
                        // This prevents conflicts with manual sign-in
                        if (!user) {
                            const isUserAdmin = session.user.user_metadata?.is_admin === true;
                            
                            if (isUserAdmin) {
                                // Admin users only get admin functionality
                                setUser(session.user);
                                setIsAdmin(true);
                                setUserModePreference('admin');
                            } else {
                                // Regular users get their data loaded
                                console.log('🔄 Loading user-specific data via auth state change...');
                                await loadUserSpecificData(session.user.id);
                                setUser(session.user);
                                setIsAdmin(false);
                            }
                        }
                    } else if (event === 'SIGNED_OUT') {
                        console.log('🔄 Auth state change: SIGNED_OUT');
                        setUser(null);
                        setIsAdmin(false);
                        setUserModePreference('admin');
                        localStorage.removeItem('dailyDavidMode');
                    }
                });

                // Add timeout to prevent infinite loading
                const authTimeout = setTimeout(() => {
                    console.log('Auth initialization timeout, forcing auth loading to false');
                    setAuthLoading(false);
                }, 15000); // 15 second timeout
                
                initializeAuth().finally(() => {
                    clearTimeout(authTimeout);
                });

                // IMMEDIATE DATA RESTORATION: Force restore data after auth initialization
                const immediateDataRestore = async () => {
                    // Wait a bit for auth to complete
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    if (user && !isAdmin) {
                        console.log('🚨 IMMEDIATE: Force restoring data after auth initialization');
                        const goalsKey = `dailyDavid_goals_${user.id}`;
                        const dayDataKey = `dailyDavid_dayData_${user.id}`;
                        const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                        const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                        
                        console.log('🔍 IMMEDIATE: Checking localStorage keys:');
                        console.log('🔑 Goals key:', goalsKey);
                        console.log('🔑 Day data key:', dayDataKey);
                        console.log('🔑 Backup key:', backupKey);
                        console.log('🔑 Emergency key:', emergencyKey);
                        
                        const goalsData = localStorage.getItem(goalsKey);
                        const dayDataRaw = localStorage.getItem(dayDataKey);
                        const backupData = localStorage.getItem(backupKey);
                        const emergencyData = localStorage.getItem(emergencyKey);
                        
                        console.log('📊 IMMEDIATE: Found data:');
                        console.log('- Goals:', !!goalsData);
                        console.log('- Day data (primary):', !!dayDataRaw);
                        console.log('- Day data (backup):', !!backupData);
                        console.log('- Day data (emergency):', !!emergencyData);
                        
                        if (goalsData || dayDataRaw || backupData || emergencyData) {
                            console.log('🚨 IMMEDIATE: Found data, restoring now');
                            
                            let weeklyGoals = [];
                            let monthlyGoals = [];
                            let dayData = {};
                            
                            if (goalsData) {
                                try {
                                    const parsed = JSON.parse(goalsData);
                                    weeklyGoals = parsed.weeklyGoals || [];
                                    monthlyGoals = parsed.monthlyGoals || [];
                                    console.log('✅ IMMEDIATE: Goals restored');
                                } catch (error) {
                                    console.error('❌ Error parsing goals:', error);
                                }
                            }
                            
                            if (dayDataRaw) {
                                try {
                                    dayData = JSON.parse(dayDataRaw);
                                    console.log('✅ IMMEDIATE: Day data restored from primary');
                                } catch (error) {
                                    console.error('❌ Error parsing primary day data:', error);
                                }
                            } else if (backupData) {
                                try {
                                    dayData = JSON.parse(backupData);
                                    console.log('✅ IMMEDIATE: Day data restored from backup');
                                } catch (error) {
                                    console.error('❌ Error parsing backup day data:', error);
                                }
                            } else if (emergencyData) {
                                try {
                                    dayData = JSON.parse(emergencyData);
                                    console.log('✅ IMMEDIATE: Day data restored from emergency');
                                } catch (error) {
                                    console.error('❌ Error parsing emergency day data:', error);
                                }
                            }
                            
                            debugSetUserSpecificData({
                                dayData: dayData,
                                weeklyGoals: weeklyGoals,
                                monthlyGoals: monthlyGoals
                            });
                            
                            console.log('🚨 IMMEDIATE: Data restoration complete');
                        } else {
                            console.log('⚠️ IMMEDIATE: No data found in localStorage');
                        }
                    }
                };
                
                // Run immediate data restoration after auth
                setTimeout(immediateDataRestore, 200);

                return () => subscription?.unsubscribe();
            }, []);

            // Clean up timeout
            useEffect(() => {
                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, []);

            // Debug: Log when view changes
            useEffect(() => {
                console.log('🔄 View changed to:', currentView);
                console.log('📅 Current date:', formatDateKey(currentDate));
                console.log('📊 Current day data:', currentDayData);
                
                // AGGRESSIVE: When view changes to daily, immediately restore data if missing
                if (currentView === 'daily' && user && !isAdmin) {
                    console.log('🚨 VIEW CHANGE: Switched to daily view, checking data...');
                    
                    const hasData = Object.keys(userSpecificData.dayData).length > 0 || 
                                   userSpecificData.weeklyGoals.length > 0 || 
                                   userSpecificData.monthlyGoals.length > 0;
                    
                    if (!hasData) {
                        console.log('🚨 VIEW CHANGE: No data found, restoring immediately...');
                        
                        const goalsKey = `dailyDavid_goals_${user.id}`;
                        const dayDataKey = `dailyDavid_dayData_${user.id}`;
                        const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                        const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                        
                        const goalsData = localStorage.getItem(goalsKey);
                        const dayDataRaw = localStorage.getItem(dayDataKey);
                        const backupData = localStorage.getItem(backupKey);
                        const emergencyData = localStorage.getItem(emergencyKey);
                        
                        if (goalsData || dayDataRaw || backupData || emergencyData) {
                            let weeklyGoals = [];
                            let monthlyGoals = [];
                            let dayData = {};
                            
                            if (goalsData) {
                                try {
                                    const parsed = JSON.parse(goalsData);
                                    weeklyGoals = parsed.weeklyGoals || [];
                                    monthlyGoals = parsed.monthlyGoals || [];
                                } catch (error) {
                                    console.error('❌ Error parsing goals:', error);
                                }
                            }
                            
                            if (dayDataRaw) {
                                try {
                                    dayData = JSON.parse(dayDataRaw);
                                } catch (error) {
                                    console.error('❌ Error parsing primary day data:', error);
                                }
                            } else if (backupData) {
                                try {
                                    dayData = JSON.parse(backupData);
                                } catch (error) {
                                    console.error('❌ Error parsing backup day data:', error);
                                }
                            } else if (emergencyData) {
                                try {
                                    dayData = JSON.parse(emergencyData);
                                } catch (error) {
                                    console.error('❌ Error parsing emergency day data:', error);
                                }
                            }
                            
                            debugSetUserSpecificData({
                                dayData: dayData,
                                weeklyGoals: weeklyGoals,
                                monthlyGoals: monthlyGoals
                            });
                            
                            console.log('🚨 VIEW CHANGE: Data restored successfully');
                        }
                    } else {
                        console.log('🚨 VIEW CHANGE: Data already exists, no restoration needed');
                    }
                }
            }, [currentView, currentDate, currentDayData, user, isAdmin, userSpecificData.dayData, userSpecificData.weeklyGoals, userSpecificData.monthlyGoals]);

            // BULLETPROOF: Force restore data from localStorage whenever user changes
            useEffect(() => {
                if (user && !isAdmin) {
                    console.log('🔄 BULLETPROOF: User changed, forcing data restore from localStorage');
                    console.log('🔄 User ID:', user.id);
                    console.log('🔄 Current userSpecificData state:', userSpecificData);
                    
                    // Force restore data from localStorage
                    const forceRestoreData = () => {
                        try {
                            const goalsKey = `dailyDavid_goals_${user.id}`;
                            const dayDataKey = `dailyDavid_dayData_${user.id}`;
                            const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                            const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                            
                            console.log('🔍 Checking localStorage keys:');
                            console.log('🔑 Goals key:', goalsKey);
                            console.log('🔑 Day data key:', dayDataKey);
                            console.log('🔑 Backup key:', backupKey);
                            console.log('🔑 Emergency key:', emergencyKey);
                            
                            const goalsData = localStorage.getItem(goalsKey);
                            const dayDataRaw = localStorage.getItem(dayDataKey);
                            const backupData = localStorage.getItem(backupKey);
                            const emergencyData = localStorage.getItem(emergencyKey);
                            
                            console.log('📊 Found data in localStorage:');
                            console.log('- Goals:', !!goalsData);
                            console.log('- Day data (primary):', !!dayDataRaw);
                            console.log('- Day data (backup):', !!backupData);
                            console.log('- Day data (emergency):', !!emergencyData);
                            
                            if (goalsData || dayDataRaw || backupData || emergencyData) {
                                console.log('🔄 Found data in localStorage, restoring...');
                                
                                let weeklyGoals = [];
                                let monthlyGoals = [];
                                let dayData = {};
                                
                                if (goalsData) {
                                    try {
                                        const parsed = JSON.parse(goalsData);
                                        weeklyGoals = parsed.weeklyGoals || [];
                                        monthlyGoals = parsed.monthlyGoals || [];
                                        console.log('✅ Restored goals from localStorage:', { weeklyGoals, monthlyGoals });
                                    } catch (error) {
                                        console.error('❌ Error parsing goals:', error);
                                    }
                                }
                                
                                // Try primary key first, then backup, then emergency
                                if (dayDataRaw) {
                                    try {
                                        dayData = JSON.parse(dayDataRaw);
                                        console.log('✅ Restored day data from primary localStorage:', Object.keys(dayData).length, 'dates');
                                        console.log('📅 Date keys found:', Object.keys(dayData));
                                    } catch (error) {
                                        console.error('❌ Error parsing primary day data:', error);
                                    }
                                } else if (backupData) {
                                    try {
                                        dayData = JSON.parse(backupData);
                                        console.log('✅ Restored day data from backup localStorage:', Object.keys(dayData).length, 'dates');
                                        console.log('📅 Date keys found:', Object.keys(dayData));
                                    } catch (error) {
                                        console.error('❌ Error parsing backup day data:', error);
                                    }
                                } else if (emergencyData) {
                                    try {
                                        dayData = JSON.parse(emergencyData);
                                        console.log('✅ Restored day data from emergency localStorage:', Object.keys(dayData).length, 'dates');
                                        console.log('📅 Date keys found:', Object.keys(dayData));
                                    } catch (error) {
                                        console.error('❌ Error parsing emergency day data:', error);
                                    }
                                }
                                
                                console.log('🔄 About to update userSpecificData state with:');
                                console.log('- dayData:', dayData);
                                console.log('- weeklyGoals:', weeklyGoals);
                                console.log('- monthlyGoals:', monthlyGoals);
                                
                                // Force update state
                                debugSetUserSpecificData(prev => {
                                    const newState = {
                                        ...prev,
                                        dayData: dayData,
                                        weeklyGoals: weeklyGoals,
                                        monthlyGoals: monthlyGoals
                                    };
                                    console.log('🔄 New state will be:', newState);
                                    return newState;
                                });
                                
                                console.log('✅ BULLETPROOF: Data restored from localStorage');
                            } else {
                                console.log('⚠️ No data found in any localStorage keys');
                            }
                        } catch (error) {
                            console.error('❌ Error in force restore:', error);
                        }
                    };
                    
                    // Run immediately
                    forceRestoreData();
                    
                    // Also run after a short delay to catch any race conditions
                    setTimeout(forceRestoreData, 1000);
                    
                    // Run again after a longer delay to ensure it sticks
                    setTimeout(forceRestoreData, 3000);
                }
            }, [user?.id, isAdmin]);

            // AGGRESSIVE: Restore data when data is missing (but prevent infinite loops)
            useEffect(() => {
                if (user && !isAdmin) {
                    // Check if data is missing and restore it
                    const hasData = Object.keys(userSpecificData.dayData).length > 0 || 
                                   userSpecificData.weeklyGoals.length > 0 || 
                                   userSpecificData.monthlyGoals.length > 0;
                    
                    if (!hasData) {
                        console.log('🚨 AGGRESSIVE: No data detected, restoring from localStorage');
                        const goalsKey = `dailyDavid_goals_${user.id}`;
                        const dayDataKey = `dailyDavid_dayData_${user.id}`;
                        const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                        const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                        
                        const goalsData = localStorage.getItem(goalsKey);
                        const dayDataRaw = localStorage.getItem(dayDataKey);
                        const backupData = localStorage.getItem(backupKey);
                        const emergencyData = localStorage.getItem(emergencyKey);
                        
                        if (goalsData || dayDataRaw || backupData || emergencyData) {
                            console.log('🚨 AGGRESSIVE: Found data in localStorage, restoring immediately');
                            
                            let weeklyGoals = [];
                            let monthlyGoals = [];
                            let dayData = {};
                            
                            if (goalsData) {
                                try {
                                    const parsed = JSON.parse(goalsData);
                                    weeklyGoals = parsed.weeklyGoals || [];
                                    monthlyGoals = parsed.monthlyGoals || [];
                                } catch (error) {
                                    console.error('❌ Error parsing goals:', error);
                                }
                            }
                            
                            if (dayDataRaw) {
                                try {
                                    dayData = JSON.parse(dayDataRaw);
                                } catch (error) {
                                    console.error('❌ Error parsing primary day data:', error);
                                }
                            } else if (backupData) {
                                try {
                                    dayData = JSON.parse(backupData);
                                } catch (error) {
                                    console.error('❌ Error parsing backup day data:', error);
                                }
                            } else if (emergencyData) {
                                try {
                                    dayData = JSON.parse(emergencyData);
                                } catch (error) {
                                    console.error('❌ Error parsing emergency day data:', error);
                                }
                            }
                            
                            setUserSpecificData({
                                dayData: dayData,
                                weeklyGoals: weeklyGoals,
                                monthlyGoals: monthlyGoals
                            });
                            
                            console.log('🚨 AGGRESSIVE: Data restored successfully');
                        }
                    }
                }
            }, [user?.id, isAdmin, userSpecificData.dayData, userSpecificData.weeklyGoals, userSpecificData.monthlyGoals]);

            // EMERGENCY: Manual data restoration function
            const emergencyRestoreData = () => {
                if (!user) return;
                
                console.log('🚨 EMERGENCY: Manual data restoration triggered');
                
                try {
                    const goalsKey = `dailyDavid_goals_${user.id}`;
                    const dayDataKey = `dailyDavid_dayData_${user.id}`;
                    const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                    const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                    
                    console.log('🔍 Checking all localStorage keys for user:', user.id);
                    console.log('🔑 Goals key:', goalsKey);
                    console.log('🔑 Day data key:', dayDataKey);
                    console.log('🔑 Backup key:', backupKey);
                    console.log('🔑 Emergency key:', emergencyKey);
                    
                    const goalsData = localStorage.getItem(goalsKey);
                    const dayDataRaw = localStorage.getItem(dayDataKey);
                    const backupData = localStorage.getItem(backupKey);
                    const emergencyData = localStorage.getItem(emergencyKey);
                    
                    console.log('📊 Found data:');
                    console.log('- Goals:', !!goalsData);
                    console.log('- Day data (primary):', !!dayDataRaw);
                    console.log('- Day data (backup):', !!backupData);
                    console.log('- Day data (emergency):', !!emergencyData);
                    
                    let weeklyGoals = [];
                    let monthlyGoals = [];
                    let dayData = {};
                    
                    // Restore goals
                    if (goalsData) {
                        try {
                            const parsed = JSON.parse(goalsData);
                            weeklyGoals = parsed.weeklyGoals || [];
                            monthlyGoals = parsed.monthlyGoals || [];
                            console.log('✅ Emergency restored goals:', { weeklyGoals, monthlyGoals });
                        } catch (error) {
                            console.error('❌ Error parsing goals:', error);
                        }
                    }
                    
                    // Restore day data (try all keys)
                    if (dayDataRaw) {
                        try {
                            dayData = JSON.parse(dayDataRaw);
                            console.log('✅ Emergency restored day data from primary:', Object.keys(dayData).length, 'dates');
                        } catch (error) {
                            console.error('❌ Error parsing primary day data:', error);
                        }
                    } else if (backupData) {
                        try {
                            dayData = JSON.parse(backupData);
                            console.log('✅ Emergency restored day data from backup:', Object.keys(dayData).length, 'dates');
                        } catch (error) {
                            console.error('❌ Error parsing backup day data:', error);
                        }
                    } else if (emergencyData) {
                        try {
                            dayData = JSON.parse(emergencyData);
                            console.log('✅ Emergency restored day data from emergency:', Object.keys(dayData).length, 'dates');
                        } catch (error) {
                            console.error('❌ Error parsing emergency day data:', error);
                        }
                    }
                    
                    // Force update state
                    setUserSpecificData({
                        dayData: dayData,
                        weeklyGoals: weeklyGoals,
                        monthlyGoals: monthlyGoals
                    });
                    
                    console.log('🚨 EMERGENCY: Data restoration complete');
                    console.log('📊 Final state - dayData keys:', Object.keys(dayData));
                    console.log('📊 Final state - weeklyGoals count:', weeklyGoals.length);
                    console.log('📊 Final state - monthlyGoals count:', monthlyGoals.length);
                    
                } catch (error) {
                    console.error('❌ CRITICAL ERROR in emergency restore:', error);
                }
            };

            // GLOBAL DATA MONITORING: Track when userSpecificData changes
            useEffect(() => {
                if (user && !isAdmin) {
                    console.log('🔍 GLOBAL MONITOR: userSpecificData state changed');
                    console.log('🔍 New state:', userSpecificData);
                    console.log('🔍 Day data keys:', Object.keys(userSpecificData.dayData));
                    console.log('🔍 Weekly goals count:', userSpecificData.weeklyGoals.length);
                    console.log('🔍 Monthly goals count:', userSpecificData.monthlyGoals.length);
                    
                    // Check if data was cleared unexpectedly
                    if (Object.keys(userSpecificData.dayData).length === 0 && 
                        userSpecificData.weeklyGoals.length === 0 && 
                        userSpecificData.monthlyGoals.length === 0) {
                        console.log('🚨 WARNING: All data appears to be cleared!');
                        console.log('🚨 This might indicate data is being reset somewhere');
                        
                        // Try to restore from localStorage immediately
                        setTimeout(() => {
                            console.log('🚨 Attempting emergency restore due to data clearing...');
                            emergencyRestoreData();
                        }, 100);
                    }
                }
            }, [userSpecificData, user, isAdmin]);

            // CONSTANT DATA RESTORATION: Force restore data on every render when needed
            useEffect(() => {
                if (user && !isAdmin) {
                    // Check if we have data in localStorage but not in state
                    const goalsKey = `dailyDavid_goals_${user.id}`;
                    const dayDataKey = `dailyDavid_dayData_${user.id}`;
                    const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                    const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                    
                    const goalsData = localStorage.getItem(goalsKey);
                    const dayDataRaw = localStorage.getItem(dayDataKey);
                    const backupData = localStorage.getItem(backupKey);
                    const emergencyData = localStorage.getItem(emergencyKey);
                    
                    const hasLocalStorageData = goalsData || dayDataRaw || backupData || emergencyData;
                    const hasStateData = Object.keys(userSpecificData.dayData).length > 0 || 
                                       userSpecificData.weeklyGoals.length > 0 || 
                                       userSpecificData.monthlyGoals.length > 0;
                    
                    if (hasLocalStorageData && !hasStateData) {
                        console.log('🚨 CONSTANT: localStorage has data but state is empty, restoring...');
                        
                        let weeklyGoals = [];
                        let monthlyGoals = [];
                        let dayData = {};
                        
                        if (goalsData) {
                            try {
                                const parsed = JSON.parse(goalsData);
                                weeklyGoals = parsed.weeklyGoals || [];
                                monthlyGoals = parsed.monthlyGoals || [];
                            } catch (error) {
                                console.error('❌ Error parsing goals:', error);
                            }
                        }
                        
                        if (dayDataRaw) {
                            try {
                                dayData = JSON.parse(dayDataRaw);
                            } catch (error) {
                                console.error('❌ Error parsing primary day data:', error);
                            }
                        } else if (backupData) {
                            try {
                                dayData = JSON.parse(backupData);
                            } catch (error) {
                                console.error('❌ Error parsing backup day data:', error);
                            }
                        } else if (emergencyData) {
                            try {
                                dayData = JSON.parse(emergencyData);
                            } catch (error) {
                                console.error('❌ Error parsing emergency day data:', error);
                            }
                        }
                        
                        debugSetUserSpecificData({
                            dayData: dayData,
                            weeklyGoals: weeklyGoals,
                            monthlyGoals: monthlyGoals
                        });
                        
                        console.log('🚨 CONSTANT: Data restored successfully');
                    }
                }
            });

            // AGGRESSIVE: Check and restore data on EVERY render
            const aggressiveDataCheck = () => {
                if (user && !isAdmin) {
                    const goalsKey = `dailyDavid_goals_${user.id}`;
                    const dayDataKey = `dailyDavid_dayData_${user.id}`;
                    const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                    const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                    
                    const goalsData = localStorage.getItem(goalsKey);
                    const dayDataRaw = localStorage.getItem(dayDataKey);
                    const backupData = localStorage.getItem(backupKey);
                    const emergencyData = localStorage.getItem(emergencyKey);
                    
                    const hasLocalStorageData = goalsData || dayDataRaw || backupData || emergencyData;
                    const hasStateData = Object.keys(userSpecificData.dayData).length > 0 || 
                                       userSpecificData.weeklyGoals.length > 0 || 
                                       userSpecificData.monthlyGoals.length > 0;
                    
                    if (hasLocalStorageData && !hasStateData) {
                        console.log('🚨 AGGRESSIVE: Data missing on render, restoring immediately');
                        
                        let weeklyGoals = [];
                        let monthlyGoals = [];
                        let dayData = {};
                        
                        if (goalsData) {
                            try {
                                const parsed = JSON.parse(goalsData);
                                weeklyGoals = parsed.weeklyGoals || [];
                                monthlyGoals = parsed.monthlyGoals || [];
                            } catch (error) {
                                console.error('❌ Error parsing goals:', error);
                            }
                        }
                        
                        if (dayDataRaw) {
                            try {
                                dayData = JSON.parse(dayDataRaw);
                            } catch (error) {
                                console.error('❌ Error parsing primary day data:', error);
                            }
                        } else if (backupData) {
                            try {
                                dayData = JSON.parse(backupData);
                            } catch (error) {
                                console.error('❌ Error parsing backup day data:', error);
                            }
                        } else if (emergencyData) {
                            try {
                                dayData = JSON.parse(emergencyData);
                            } catch (error) {
                                console.error('❌ Error parsing emergency day data:', error);
                            }
                        }
                        
                        debugSetUserSpecificData({
                            dayData: dayData,
                            weeklyGoals: weeklyGoals,
                            monthlyGoals: monthlyGoals
                        });
                        
                        console.log('🚨 AGGRESSIVE: Data restored on render');
                    }
                }
            };
            
            // Call aggressive check on every render
            aggressiveDataCheck();
            
            // ULTRA AGGRESSIVE: Check data on every render when in daily view
            if (currentView === 'daily' && user && !isAdmin) {
                const hasData = Object.keys(userSpecificData.dayData).length > 0 || 
                               userSpecificData.weeklyGoals.length > 0 || 
                               userSpecificData.monthlyGoals.length > 0;
                
                if (!hasData) {
                    console.log('🚨 ULTRA AGGRESSIVE: In daily view with no data, restoring immediately');
                    
                    const goalsKey = `dailyDavid_goals_${user.id}`;
                    const dayDataKey = `dailyDavid_dayData_${user.id}`;
                    const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                    const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                    
                    const goalsData = localStorage.getItem(goalsKey);
                    const dayDataRaw = localStorage.getItem(dayDataKey);
                    const backupData = localStorage.getItem(backupKey);
                    const emergencyData = localStorage.getItem(emergencyKey);
                    
                    if (goalsData || dayDataRaw || backupData || emergencyData) {
                        let weeklyGoals = [];
                        let monthlyGoals = [];
                        let dayData = {};
                        
                        if (goalsData) {
                            try {
                                const parsed = JSON.parse(goalsData);
                                weeklyGoals = parsed.weeklyGoals || [];
                                monthlyGoals = parsed.monthlyGoals || [];
                            } catch (error) {
                                console.error('❌ Error parsing goals:', error);
                            }
                        }
                        
                        if (dayDataRaw) {
                            try {
                                dayData = JSON.parse(dayDataRaw);
                            } catch (error) {
                                console.error('❌ Error parsing primary day data:', error);
                            }
                        } else if (backupData) {
                            try {
                                dayData = JSON.parse(backupData);
                            } catch (error) {
                                console.error('❌ Error parsing backup day data:', error);
                            }
                        } else if (emergencyData) {
                            try {
                                dayData = JSON.parse(emergencyData);
                            } catch (error) {
                                console.error('❌ Error parsing emergency day data:', error);
                            }
                        }
                        
                        debugSetUserSpecificData({
                            dayData: dayData,
                            weeklyGoals: weeklyGoals,
                            monthlyGoals: monthlyGoals
                        });
                        
                        console.log('🚨 ULTRA AGGRESSIVE: Data restored on render');
                    }
                }
            }

            // DEBUG: Track ALL state changes to find what's clearing data
            useEffect(() => {
                console.log('🔍 DEBUG: userSpecificData changed - Stack trace:');
                console.trace('userSpecificData change stack trace');
                
                if (user && !isAdmin) {
                    console.log('🔍 DEBUG: Current userSpecificData state:', userSpecificData);
                    console.log('🔍 DEBUG: Day data keys:', Object.keys(userSpecificData.dayData));
                    console.log('🔍 DEBUG: Weekly goals count:', userSpecificData.weeklyGoals.length);
                    console.log('🔍 DEBUG: Monthly goals count:', userSpecificData.monthlyGoals.length);
                    
                    // Check if data was just cleared
                    if (Object.keys(userSpecificData.dayData).length === 0 && 
                        userSpecificData.weeklyGoals.length === 0 && 
                        userSpecificData.monthlyGoals.length === 0) {
                        console.log('🚨 DEBUG: DATA WAS JUST CLEARED!');
                        console.log('🚨 DEBUG: This happened after the previous state change');
                        console.log('🚨 DEBUG: Previous state should have had data');
                        
                        // Check localStorage to see if data still exists there
                        const goalsKey = `dailyDavid_goals_${user.id}`;
                        const dayDataKey = `dailyDavid_dayData_${user.id}`;
                        const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                        const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                        
                        const goalsData = localStorage.getItem(goalsKey);
                        const dayDataRaw = localStorage.getItem(dayDataKey);
                        const backupData = localStorage.getItem(backupKey);
                        const emergencyData = localStorage.getItem(emergencyKey);
                        
                        console.log('🔍 DEBUG: localStorage state when data was cleared:');
                        console.log('- Goals:', !!goalsData);
                        console.log('- Day data (primary):', !!goalsData);
                        console.log('- Day data (backup):', !!backupData);
                        console.log('- Day data (emergency):', !!emergencyData);
                        
                        if (goalsData || dayDataRaw || backupData || emergencyData) {
                            console.log('🚨 DEBUG: localStorage STILL HAS DATA but state was cleared!');
                            console.log('🚨 DEBUG: This means something is clearing the React state');
                            
                            // PREVENT DATA CLEARING: Immediately restore data if it was cleared
                            console.log('🚨 PREVENTING DATA CLEARING: Restoring data immediately');
                            
                            let weeklyGoals = [];
                            let monthlyGoals = [];
                            let dayData = {};
                            
                            if (goalsData) {
                                try {
                                    const parsed = JSON.parse(goalsData);
                                    weeklyGoals = parsed.weeklyGoals || [];
                                    monthlyGoals = parsed.monthlyGoals || [];
                                } catch (error) {
                                    console.error('❌ Error parsing goals:', error);
                                }
                            }
                            
                            if (dayDataRaw) {
                                try {
                                    dayData = JSON.parse(dayDataRaw);
                                } catch (error) {
                                    console.error('❌ Error parsing primary day data:', error);
                                }
                            } else if (backupData) {
                                try {
                                    dayData = JSON.parse(backupData);
                                } catch (error) {
                                    console.error('❌ Error parsing backup day data:', error);
                                }
                            } else if (emergencyData) {
                                try {
                                    dayData = JSON.parse(emergencyData);
                                } catch (error) {
                                    console.error('❌ Error parsing emergency day data:', error);
                                }
                            }
                            
                            // Force restore the data
                            debugSetUserSpecificData({
                                dayData: dayData,
                                weeklyGoals: weeklyGoals,
                                monthlyGoals: monthlyGoals
                            });
                            
                            console.log('🚨 DATA CLEARING PREVENTED: Data restored successfully');
                        } else {
                            console.log('🚨 DEBUG: localStorage was also cleared!');
                            console.log('🚨 DEBUG: This means something is clearing localStorage');
                        }
                    }
                }
            }, [userSpecificData, user, isAdmin]);

            // NEW: Track UI rendering to see if data is being used correctly
            useEffect(() => {
                if (user && !isAdmin && currentView === 'daily') {
                    console.log('🎯 UI RENDERING DEBUG: Daily view is rendering');
                    console.log('🎯 UI RENDERING DEBUG: currentDayData:', currentDayData);
                    console.log('🎯 UI RENDERING DEBUG: userSpecificData.dayData keys:', Object.keys(userSpecificData.dayData));
                    console.log('🎯 UI RENDERING DEBUG: Current date:', currentDate);
                    console.log('🎯 UI RENDERING DEBUG: Date key:', formatDateKey(currentDate));
                    
                    // Check if the UI is getting the right data
                    const dateKey = formatDateKey(currentDate);
                    const expectedData = userSpecificData.dayData[dateKey];
                    const actualData = currentDayData;
                    
                    console.log('🎯 UI RENDERING DEBUG: Expected data for date:', !!expectedData);
                    console.log('🎯 UI RENDERING DEBUG: Actual data from currentDayData:', !!actualData);
                    console.log('🎯 UI RENDERING DEBUG: Data match:', expectedData === actualData);
                    
                    if (!actualData || Object.keys(actualData).length === 0) {
                        console.log('🚨 UI RENDERING ERROR: currentDayData is empty but should have data!');
                        console.log('🚨 UI RENDERING ERROR: This explains why the UI shows nothing!');
                        
                        // Force restore the specific date data
                        if (expectedData) {
                            console.log('🚨 UI RENDERING FIX: Restoring data for specific date');
                            debugSetUserSpecificData(prev => ({
                                ...prev,
                                dayData: { ...prev.dayData, [dateKey]: expectedData }
                            }));
                        }
                    }
                }
            }, [currentView, currentDate, currentDayData, userSpecificData.dayData, user, isAdmin]);

            // CRITICAL FIX: Ensure UI components always have access to the right data
            useEffect(() => {
                if (user && !isAdmin && currentView === 'daily') {
                    const dateKey = formatDateKey(currentDate);
                    const expectedData = userSpecificData.dayData[dateKey];
                    
                    // If we're in daily view but don't have data for the current date, restore it
                    if (!expectedData && Object.keys(userSpecificData.dayData).length > 0) {
                        console.log('🚨 CRITICAL FIX: Missing data for daily view date:', dateKey);
                        console.log('🚨 CRITICAL FIX: Available dates:', Object.keys(userSpecificData.dayData));
                        
                        // Try to get data from localStorage for this specific date
                        const dayDataKey = `dailyDavid_dayData_${user.id}`;
                        const dayDataRaw = localStorage.getItem(dayDataKey);
                        
                        if (dayDataRaw) {
                            try {
                                const dayData = JSON.parse(dayDataRaw);
                                if (dayData[dateKey]) {
                                    console.log('🚨 CRITICAL FIX: Found data in localStorage for date:', dateKey);
                                    console.log('🚨 CRITICAL FIX: Restoring to state');
                                    
                                    debugSetUserSpecificData(prev => ({
                                        ...prev,
                                        dayData: { ...prev.dayData, [dateKey]: dayData[dateKey] }
                                    }));
                                }
                            } catch (error) {
                                console.error('❌ Error parsing day data for critical fix:', error);
                            }
                        }
                    }
                }
            }, [currentView, currentDate, userSpecificData.dayData, user, isAdmin]);

            // FINAL DEBUG: Track what the UI components are actually receiving
            useEffect(() => {
                if (user && !isAdmin && currentView === 'daily' && currentDayData) {
                    console.log('🎯 FINAL DEBUG: UI Components should be receiving this data:');
                    console.log('🎯 FINAL DEBUG: currentDayData.gratitude:', currentDayData.gratitude);
                    console.log('🎯 FINAL DEBUG: currentDayData.soap:', currentDayData.soap);
                    console.log('🎯 FINAL DEBUG: currentDayData.goals:', currentDayData.goals);
                    console.log('🎯 FINAL DEBUG: currentDayData.gratitude.length:', currentDayData.gratitude?.length);
                    console.log('🎯 FINAL DEBUG: currentDayData.soap.thoughts:', currentDayData.soap?.thoughts);
                    console.log('🎯 FINAL DEBUG: currentDayData.goals.daily:', currentDayData.goals?.daily);
                    
                    // Check if the data structure is correct
                    if (currentDayData.gratitude && Array.isArray(currentDayData.gratitude)) {
                        console.log('✅ FINAL DEBUG: Gratitude array is valid, length:', currentDayData.gratitude.length);
                        currentDayData.gratitude.forEach((item, index) => {
                            console.log(`✅ FINAL DEBUG: Gratitude[${index}]:`, item);
                        });
                    } else {
                        console.log('❌ FINAL DEBUG: Gratitude is NOT valid:', currentDayData.gratitude);
                    }
                    
                    if (currentDayData.soap && typeof currentDayData.soap === 'object') {
                        console.log('✅ FINAL DEBUG: SOAP object is valid:', currentDayData.soap);
                    } else {
                        console.log('❌ FINAL DEBUG: SOAP is NOT valid:', currentDayData.soap);
                    }
                    
                    if (currentDayData.goals && typeof currentDayData.goals === 'object') {
                        console.log('✅ FINAL DEBUG: Goals object is valid:', currentDayData.goals);
                    } else {
                        console.log('❌ FINAL DEBUG: Goals is NOT valid:', currentDayData.goals);
                    }
                }
            }, [currentView, currentDayData, user, isAdmin]);

            // IMMEDIATE DATA CLEARING DETECTION: Check if data is cleared immediately after being set
            const prevStateRef = useRef(userSpecificData);
            
            useEffect(() => {
                if (user && !isAdmin) {
                    // Check if data was just set and then immediately cleared
                    const prevHasData = Object.keys(prevStateRef.current.dayData).length > 0 || 
                                       prevStateRef.current.weeklyGoals.length > 0 || 
                                       prevStateRef.current.monthlyGoals.length > 0;
                    
                    const currentHasData = Object.keys(userSpecificData.dayData).length > 0 || 
                                         userSpecificData.weeklyGoals.length > 0 || 
                                         userSpecificData.monthlyGoals.length > 0;
                    
                    if (prevHasData && !currentHasData) {
                        console.log('🚨 IMMEDIATE CLEARING DETECTED!');
                        console.log('🚨 Data was just set and then immediately cleared!');
                        console.log('🚨 Previous state had data, current state is empty');
                        console.log('🚨 This suggests a race condition or conflicting effect');
                        
                        // Check what effects are running
                        console.log('🚨 Checking for conflicting effects...');
                        
                        // Force immediate restoration
                        setTimeout(() => {
                            console.log('🚨 Attempting immediate restoration after clearing detection...');
                            emergencyRestoreData();
                        }, 0);
                    }
                    
                    // Update the ref for next comparison
                    prevStateRef.current = userSpecificData;
                }
            }, [userSpecificData, user, isAdmin]);

            // TRACK ALL EFFECTS: Monitor when effects run to find the culprit
            useEffect(() => {
                console.log('🔍 TRACK: Effect with userSpecificData dependency ran');
                console.log('🔍 TRACK: Current userSpecificData:', userSpecificData);
                console.log('🔍 TRACK: Stack trace for this effect:');
                console.trace('Effect with userSpecificData dependency');
            }, [userSpecificData]);

            // TRACK USER CHANGES: Monitor when user state changes
            useEffect(() => {
                console.log('🔍 TRACK: User state changed');
                console.log('🔍 TRACK: New user:', user);
                console.log('🔍 TRACK: Is admin:', isAdmin);
                console.log('🔍 TRACK: Stack trace for user change:');
                console.trace('User state change');
            }, [user, isAdmin]);

            // TRACK AUTH LOADING: Monitor auth loading state
            useEffect(() => {
                console.log('🔍 TRACK: Auth loading state changed:', authLoading);
                console.log('🔍 TRACK: Stack trace for auth loading change:');
                console.trace('Auth loading change');
            }, [authLoading]);

            // Use useMemo to properly calculate currentDayData based on current state
            const currentDayData = useMemo(() => {
                const dateKey = formatDateKey(currentDate);
                const existingData = userSpecificData.dayData[dateKey];
                
                // DEBUG: Log what's happening in currentDayData calculation
                console.log('🔍 currentDayData useMemo running:');
                console.log('🔍 Date key:', dateKey);
                console.log('🔍 Existing data found:', !!existingData);
                console.log('🔍 userSpecificData.dayData keys:', Object.keys(userSpecificData.dayData));
                
                if (existingData) {
                    console.log('🔍 Returning existing data for date:', dateKey);
                    return existingData;
                }
                
                // Check if we should have data but it's missing
                if (Object.keys(userSpecificData.dayData).length > 0) {
                    console.log('🚨 WARNING: Data exists in userSpecificData but not for this date');
                    console.log('🚨 Available dates:', Object.keys(userSpecificData.dayData));
                    console.log('🚨 Requested date:', dateKey);
                    
                    // Try to restore data if it's missing for this specific date
                    if (user && !isAdmin) {
                        const dayDataKey = `dailyDavid_dayData_${user.id}`;
                        const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                        const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                        
                        const dayDataRaw = localStorage.getItem(dayDataKey);
                        const backupData = localStorage.getItem(backupKey);
                        const emergencyData = localStorage.getItem(emergencyKey);
                        
                        if (dayDataRaw || backupData || emergencyData) {
                            console.log('🚨 Attempting to restore missing date data...');
                            
                            let dayData = {};
                            if (dayDataRaw) {
                                try {
                                    dayData = JSON.parse(dayDataRaw);
                                    if (dayData[dateKey]) {
                                        console.log('🚨 Found data for date in localStorage, updating state');
                                        debugSetUserSpecificData(prev => ({
                                            ...prev,
                                            dayData: { ...prev.dayData, [dateKey]: dayData[dateKey] }
                                        }));
                                        return dayData[dateKey];
                                    }
                                } catch (error) {
                                    console.error('❌ Error parsing day data:', error);
                                }
                            }
                        }
                    }
                }
                
                console.log('🔍 Returning default structure for date:', dateKey);
                // Return default structure if no data exists
                return {
                    gratitude: ['', '', '', '', ''],
                    soap: {
                        scripture: '',
                        observation: '',
                        application: '',
                        prayer: ''
                    },
                    goals: {
                        daily: [],
                        weekly: [],
                        monthly: []
                    }
                };
            }, [currentDate, userSpecificData.dayData, user, isAdmin]);

            // Update functions
            const updateGratitude = (index, value) => {
                console.log('🔄 DEBUG: updateGratitude called with:');
                console.log('🔄 DEBUG: index:', index);
                console.log('🔄 DEBUG: value:', value);
                console.log('🔄 DEBUG: currentDate:', currentDate);
                
                const dateKey = formatDateKey(currentDate);
                console.log('🔄 DEBUG: dateKey:', dateKey);
                
                // Update the state immediately with the new value
                setUserSpecificData(prev => {
                    console.log('🔄 DEBUG: Inside setUserSpecificData callback');
                    console.log('🔄 DEBUG: prev.dayData[dateKey]:', prev.dayData[dateKey]);
                    
                    const currentDayData = prev.dayData[dateKey];
                    if (!currentDayData) {
                        console.log('❌ DEBUG: No currentDayData found for dateKey:', dateKey);
                        return prev;
                    }
                    
                    console.log('🔄 DEBUG: currentDayData.gratitude:', currentDayData.gratitude);
                    
                    const newData = {
                        ...currentDayData,
                        gratitude: currentDayData.gratitude.map((item, i) => i === index ? value : item)
                    };
                    
                    console.log('🔄 DEBUG: newData.gratitude:', newData.gratitude);
                    console.log('🔄 DEBUG: About to call debouncedSave');
                    
                    // Save to localStorage and database using the SAME newData
                    debouncedSave(dateKey, newData);
                    
                    console.log('🔄 DEBUG: debouncedSave called, returning new state');
                    
                    return {
                        ...prev,
                        dayData: { ...prev.dayData, [dateKey]: newData }
                    };
                });
            };

            const updateSOAP = (section, value) => {
                const dateKey = formatDateKey(currentDate);
                
                // Update the state immediately with the new value
                setUserSpecificData(prev => {
                    const currentDayData = prev.dayData[dateKey];
                    if (!currentDayData) return prev;
                    
                    const newData = {
                        ...currentDayData,
                        soap: {
                            ...currentDayData.soap,
                            [section]: value
                        }
                    };
                    
                    // Save to localStorage and database using the SAME newData
                    debouncedSave(dateKey, newData);
                    
                    return {
                        ...prev,
                        dayData: { ...prev.dayData, [dateKey]: newData }
                    };
                });
            };

            // Removed duplicate goal functions - using addDailyGoal, updateDailyGoal, etc. instead

            const navigateDate = (direction) => {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() + direction);
                setCurrentDate(newDate);
            };

            // Show loading while auth is initializing
            if (authLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p className="text-gray-600">Initializing...</p>
                        </div>
                    </div>
                );
            }

            // Show sign-in screen if not authenticated
            if (!user) {
                return (
                    <SignInScreen 
                        onSignIn={handleSignIn}
                        onAdminSignIn={handleAdminSignIn}
                    />
                );
            }

            // Show admin panel if user is admin
            if (isAdmin) {
                return (
                                            <AdminPanel 
                            user={user}
                            onSignOut={handleSignOut}
                            onAddUser={handleAddUser}
                            onRemoveUser={handleRemoveUser}
                            useServiceRoleKey={USE_SERVICE_ROLE_KEY}
                        />
                );
            }

            // Show loading while app data is loading
            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading your daily devotions...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container mx-auto px-4 py-8 max-w-6xl">
                    {/* Header Section */}
                    <div className="section-card rounded-xl p-6 mb-8">
                        <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="text-center md:text-left">
                                <h1 className="section-header text-4xl font-bold mb-2 flex items-center gap-3">
                                    <BookOpenIcon />
                                    The Daily David
                                </h1>
                                <p className="text-gray-600 text-lg">
                                    Grow in faith, gratitude, and purpose
                                </p>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <div className="text-right text-sm">
                                    <div className={`flex items-center gap-2 ${
                                        isConnected ? 'text-green-600' : 'text-red-600'
                                    }`}>
                                        <div className={`w-2 h-2 rounded-full ${
                                            isConnected ? 'bg-green-500' : 'bg-red-500'
                                        } status-indicator`}></div>
                                        {isConnected ? 'Synced' : 'Offline'}
                                    </div>
                                    {lastSaved && (
                                        <div className="text-gray-500">
                                            Last saved: {lastSaved.toLocaleTimeString()}
                                        </div>
                                    )}
                                    
                                    {/* Data Persistence Status */}
                                    {!isAdmin && user && (
                                        <div className="text-xs text-gray-500 mt-1">
                                            {(() => {
                                                const goalsKey = `dailyDavid_goals_${user.id}`;
                                                const dayDataKey = `dailyDavid_dayData_${user.id}`;
                                                const backupKey = `dailyDavid_dayData_backup_${user.id}`;
                                                const emergencyKey = `dailyDavid_dayData_emergency_${user.id}`;
                                                
                                                const goalsData = localStorage.getItem(goalsKey);
                                                const dayDataRaw = localStorage.getItem(dayDataKey);
                                                const backupData = localStorage.getItem(backupKey);
                                                const emergencyData = localStorage.getItem(emergencyKey);
                                                
                                                const totalKeys = [goalsData, dayDataRaw, backupData, emergencyData].filter(Boolean).length;
                                                return `Data: ${totalKeys}/4 keys`;
                                            })()}
                                        </div>
                                    )}
                                </div>
                                
                                {/* User Info and Sign Out */}
                                <div className="flex items-center gap-3">
                                    <div className="text-sm text-gray-600">
                                        Welcome, {user.email}
                                        {!isAdmin && <span className="ml-2 text-blue-600">👤 User Mode</span>}
                                    </div>

                                    {/* EMERGENCY RESTORE BUTTON */}
                                    {!isAdmin && (
                                        <button 
                                            onClick={emergencyRestoreData}
                                            className="px-3 py-1 bg-orange-500 text-white text-sm rounded-lg hover:bg-orange-600 transition-colors"
                                            title="Emergency restore data from localStorage"
                                        >
                                            🚨 Restore Data
                                        </button>
                                    )}

                                    <button 
                                        onClick={handleSignOut}
                                        className="px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 transition-colors"
                                    >
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="section-divider"></div>

                        {/* View Navigation */}
                        <div className="flex items-center justify-center gap-4 mb-6">
                            <button
                                onClick={() => setCurrentView('landing')}
                                className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                                    currentView === 'landing'
                                        ? 'bg-primary text-white shadow-md'
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                }`}
                            >
                                🏠 Dashboard
                            </button>
                            <button
                                onClick={() => setCurrentView('daily')}
                                className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                                    currentView === 'daily'
                                        ? 'bg-primary text-white shadow-md'
                                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                }`}
                            >
                                ✍️ Daily Entry
                            </button>
                        </div>

                        {/* Date Navigation */}
                        <div className="flex items-center justify-center gap-6">
                            <button 
                                onClick={() => navigateDate(-1)}
                                className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors shadow-sm"
                            >
                                <ChevronLeftIcon />
                                Previous Day
                            </button>
                            
                            <div className="text-center">
                                <h2 className="text-xl font-semibold text-gray-800">
                                    {formatDateDisplay(currentDate)}
                                </h2>
                                <p className="text-sm text-gray-500 mt-1">
                                    Day {Math.ceil((currentDate - new Date(currentDate.getFullYear(), 0, 1)) / (1000 * 60 * 60 * 24))} of {currentDate.getFullYear()}
                                </p>
                            </div>
                            
                            <button 
                                onClick={() => navigateDate(1)}
                                className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors shadow-sm"
                            >
                                Next Day
                                <ChevronRightIcon />
                            </button>
                        </div>
                    </div>

                    {/* Conditional Rendering Based on View */}
                    {currentView === 'landing' ? (
                        <LandingPage 
                            weeklyGoals={userSpecificData.weeklyGoals}
                            monthlyGoals={userSpecificData.monthlyGoals}
                            toggleGoal={toggleGoal}
                            addGoal={addGoal}
                            removeGoal={removeGoal}
                            updateGoal={updateGoal}
                            getWeeklyProgress={getWeeklyProgress}
                            getMonthlyProgress={getMonthlyProgress}
                            getDaysCompletedThisWeek={getDaysCompletedThisWeek}
                            setCurrentView={setCurrentView}
                        />
                    ) : (
                        <>
                            {/* Gratitude Section */}
                            <GratitudeSection 
                                gratitude={currentDayData.gratitude}
                                onUpdate={updateGratitude}
                            />

                            {/* SOAP Section */}
                            <SOAPSection 
                                soap={currentDayData.soap}
                                onUpdate={updateSOAP}
                            />

                            {/* Goals Section */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <GoalSection 
                            title="🎯 Daily Goals"
                            subtitle="Today's objectives"
                            goalType="daily"
                            goals={currentDayData.goals.daily || []}
                            onAdd={addDailyGoal}
                            onUpdate={(goalType, id, text, category) => updateDailyGoal(goalType, id, text)}
                            onToggle={toggleDailyGoal}
                            onRemove={removeDailyGoal}
                            color="blue"
                        />
                        
                        <GoalSection 
                            title="📅 Weekly Goals"
                            subtitle="This week's focus"
                            goalType="weekly"
                            goals={currentDayData.goals.weekly || []}
                            onAdd={addDailyGoal}
                            onUpdate={(goalType, id, text, category) => updateDailyGoal(goalType, id, text)}
                            onToggle={toggleDailyGoal}
                            onRemove={removeDailyGoal}
                            color="green"
                        />
                        
                        <GoalSection 
                            title="🗓️ Monthly Goals"
                            subtitle="This month's vision"
                            goalType="monthly"
                            goals={currentDayData.goals.monthly || []}
                            onAdd={addDailyGoal}
                            onUpdate={(goalType, id, text, category) => updateDailyGoal(goalType, id, text)}
                            onToggle={toggleDailyGoal}
                            onRemove={removeDailyGoal}
                            color="purple"
                        />
                    </div>
                        </>
                    )}

                    {/* Footer */}
                    <div className="mt-12 text-center">
                        <div className="section-divider"></div>
                        <p className="text-gray-500 text-sm flex items-center justify-center gap-2">
                            Built with <HeartIcon className="w-4 h-4 text-red-500" /> for spiritual growth and biblical discipleship
                        </p>
                        <p className="text-gray-400 text-xs mt-2">
                            "Be strong and courageous! Do not be afraid or discouraged. For the Lord your God is with you wherever you go." - Joshua 1:9
                        </p>
                    </div>
                </div>
            );
        };

        // Gratitude Component
        const GratitudeSection = ({ gratitude, onUpdate }) => {
            const [localInputs, setLocalInputs] = useState({});

            useEffect(() => {
                const newLocalInputs = {};
                gratitude.forEach((item, index) => {
                    newLocalInputs[index] = item;
                });
                setLocalInputs(newLocalInputs);
            }, [gratitude]);

            const handleInputChange = (index, value) => {
                setLocalInputs(prev => ({ ...prev, [index]: value }));
            };

            const handleInputBlur = (index) => {
                console.log('📝 DEBUG: handleInputBlur called with:');
                console.log('📝 DEBUG: index:', index);
                console.log('📝 DEBUG: localValue:', localInputs[index]);
                console.log('📝 DEBUG: currentItem:', gratitude[index]);
                console.log('📝 DEBUG: localValue !== currentItem:', localInputs[index] !== gratitude[index]);
                
                const localValue = localInputs[index];
                const currentItem = gratitude[index];
                if (localValue !== undefined && currentItem !== localValue) {
                    console.log('📝 DEBUG: Calling onUpdate with:', index, localValue);
                    onUpdate(index, localValue);
                } else {
                    console.log('📝 DEBUG: NOT calling onUpdate - values are the same or undefined');
                }
            };

            return (
                <div className="section-card rounded-xl p-6 mb-8">
                    <div className="text-center mb-6">
                        <h2 className="section-header text-2xl font-bold mb-2 flex items-center justify-center gap-2">
                            🙏 Daily Gratitude
                        </h2>
                        <p className="text-gray-600">
                            "Give thanks in all circumstances" - 1 Thessalonians 5:18
                        </p>
                    </div>

                    <div className="section-divider"></div>

                    <div className="space-y-4 max-w-4xl mx-auto">
                        {gratitude.map((item, index) => (
                            <div key={index} className="relative">
                                <textarea
                                    value={localInputs[index] !== undefined ? localInputs[index] : item}
                                    onChange={(e) => handleInputChange(index, e.target.value)}
                                    onBlur={() => handleInputBlur(index)}
                                    className="w-full text-base border-2 border-green-200 focus:border-green-400 focus:ring-2 focus:ring-green-200 rounded-xl px-5 py-4 resize-none min-h-[3rem] focus:outline-none transition-all duration-200 placeholder-gray-400"
                                    placeholder={`I'm grateful for...`}
                                    rows="1"
                                    onInput={(e) => {
                                        e.target.style.height = 'auto';
                                        e.target.style.height = e.target.scrollHeight + 'px';
                                    }}
                                />
                                <div className="absolute left-2 top-4 text-green-600 font-bold text-sm">
                                    {index + 1}.
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // SOAP Component
        const SOAPSection = ({ soap, onUpdate }) => {
            const [localInputs, setLocalInputs] = useState({});

            useEffect(() => {
                setLocalInputs({
                    scripture: soap.scripture,
                    observation: soap.observation,
                    application: soap.application,
                    prayer: soap.prayer
                });
            }, [soap]);

            const handleInputChange = (section, value) => {
                setLocalInputs(prev => ({ ...prev, [section]: value }));
            };

            const handleInputBlur = (section) => {
                const localValue = localInputs[section];
                const currentValue = soap[section];
                if (localValue !== undefined && currentValue !== localValue) {
                    onUpdate(section, localValue);
                }
            };

            const sectionConfigs = {
                scripture: {
                    title: "📖 Scripture",
                    subtitle: "Today's Bible passage",
                    placeholder: "Enter the Bible verse or passage you're studying today...",
                    color: "green"
                },
                observation: {
                    title: "👁️ Observation",
                    subtitle: "What does the passage say?",
                    placeholder: "What do you notice about this passage? What stands out? What context is important?",
                    color: "emerald"
                },
                application: {
                    title: "🎯 Application",
                    subtitle: "How does this apply to your life?",
                    placeholder: "How can you apply this passage to your life today? What changes will you make?",
                    color: "teal"
                },
                prayer: {
                    title: "🙏 Prayer",
                    subtitle: "Your response to God",
                    placeholder: "How will you pray based on this passage? What are you asking God for?",
                    color: "green"
                }
            };

            return (
                <div className="soap-card p-8 mb-8">
                    <div className="text-center mb-8">
                        <h2 className="section-header text-3xl font-bold mb-2">
                            S.O.A.P. Study
                        </h2>
                        <p className="text-gray-600 text-lg">
                            Scripture • Observation • Application • Prayer
                        </p>
                        <div className="mt-4 text-sm text-gray-500">
                            "All Scripture is God-breathed and is useful for teaching, rebuking, correcting and training in righteousness" - 2 Timothy 3:16
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {Object.entries(sectionConfigs).map(([section, config]) => (
                            <div key={section} className="modern-card border-l-4 border-l-green-500">
                                <div className="p-6">
                                    <h3 className="font-bold text-xl mb-2 text-gray-800">
                                        {config.title}
                                    </h3>
                                    <p className="text-gray-600 text-sm mb-4">
                                        {config.subtitle}
                                    </p>
                                    
                                    <textarea
                                        value={localInputs[section] || ''}
                                        onChange={(e) => handleInputChange(section, e.target.value)}
                                        onBlur={() => handleInputBlur(section)}
                                        className={`w-full text-base border-2 border-gray-200 focus:border-${config.color}-400 focus:ring-2 focus:ring-${config.color}-200 rounded-xl px-4 py-4 resize-none min-h-[150px] focus:outline-none transition-all duration-200 placeholder-gray-400`}
                                        placeholder={config.placeholder}
                                        rows="6"
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Goal Section Component
        const GoalSection = ({ title, subtitle, goalType, goals, onAdd, onUpdate, onToggle, onRemove, color }) => {
            const [localInputs, setLocalInputs] = useState({});
            const [editingGoal, setEditingGoal] = useState(null);
            const [editForm, setEditForm] = useState({ text: '', category: 'spiritual' });

            useEffect(() => {
                const newLocalInputs = {};
                goals.forEach(goal => {
                    if (!(goal.id in localInputs)) {
                        newLocalInputs[goal.id] = goal.text;
                    }
                });
                if (Object.keys(newLocalInputs).length > 0) {
                    setLocalInputs(prev => ({ ...prev, ...newLocalInputs }));
                }
            }, [goals]);

            const handleInputChange = (id, value) => {
                setLocalInputs(prev => ({ ...prev, [id]: value }));
            };

            const handleInputBlur = (id) => {
                const localValue = localInputs[id];
                const currentGoal = goals.find(goal => goal.id === id);
                if (localValue !== undefined && currentGoal && localValue !== currentGoal.text) {
                    onUpdate(goalType, id, localValue);
                }
            };

            const startEditing = (goal) => {
                setEditingGoal(goal.id);
                setEditForm({ text: goal.text, category: goal.category || 'spiritual' });
            };

            const saveEdit = () => {
                if (editForm.text.trim()) {
                    onUpdate(goalType, editingGoal, editForm.text, editForm.category);
                    setEditingGoal(null);
                    setEditForm({ text: '', category: 'spiritual' });
                }
            };

            const cancelEdit = () => {
                setEditingGoal(null);
                setEditForm({ text: '', category: 'spiritual' });
            };

            const CheckIcon = () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
            );

            const TrashIcon = () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            );

            const EditIcon = () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            );

            const colorClasses = {
                blue: {
                    header: 'from-slate-400 to-green-600',
                    button: 'bg-green-50 hover:bg-green-100 text-green-700 border-green-200',
                    check: 'bg-green-600 border-green-600'
                },
                green: {
                    header: 'from-slate-500 to-green-700',
                    button: 'bg-green-50 hover:bg-green-100 text-green-700 border-green-200',
                    check: 'bg-green-700 border-green-700'
                },
                purple: {
                    header: 'from-slate-600 to-green-800',
                    button: 'bg-green-50 hover:bg-green-100 text-green-700 border-green-200',
                    check: 'bg-green-800 border-green-800'
                }
            };

            const colors = colorClasses[color] || colorClasses.blue; // Default to blue if color is undefined

            return (
                <div className="modern-card overflow-hidden">
                    <div className={`bg-gradient-to-r ${colors.header} text-white p-6`}>
                        <h3 className="font-bold text-xl">{title}</h3>
                        <p className="text-white/90 text-sm mt-2">{subtitle}</p>
                    </div>

                    <div className="p-6">
                        <div className="space-y-4 mb-6">
                            {goals.map((goal) => (
                                <div key={goal.id} className="space-y-3">
                                    {editingGoal === goal.id ? (
                                        // Edit Mode
                                        <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Goal Text
                                                    </label>
                                                    <textarea
                                                        value={editForm.text}
                                                        onChange={(e) => setEditForm(prev => ({ ...prev, text: e.target.value }))}
                                                        className="w-full text-sm border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 resize-none min-h-[2.5rem]"
                                                        placeholder="Enter your goal..."
                                                        rows="2"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Category
                                                    </label>
                                                    <select
                                                        value={editForm.category}
                                                        onChange={(e) => setEditForm(prev => ({ ...prev, category: e.target.value }))}
                                                        className="w-full text-sm border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400"
                                                    >
                                                        <option value="spiritual">Spiritual</option>
                                                        <option value="personal">Personal</option>
                                                        <option value="outreach">Outreach</option>
                                                        <option value="health">Health</option>
                                                        <option value="work">Work</option>
                                                    </select>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={saveEdit}
                                                        className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors"
                                                    >
                                                        Save
                                                    </button>
                                                    <button
                                                        onClick={cancelEdit}
                                                        className="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition-colors"
                                                    >
                                                        Cancel
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            onRemove(goalType, goal.id);
                                                            setEditingGoal(null);
                                                        }}
                                                        className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors"
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        // View Mode
                                        <div className="flex items-start gap-3 group">
                                            <button
                                                onClick={() => onToggle(goalType, goal.id)}
                                                className={`mt-1 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all duration-200 hover:scale-110 ${
                                                    goal.completed 
                                                        ? `${colors.check} text-white shadow-lg` 
                                                        : `border-gray-300 hover:border-${color}-400 hover:bg-gray-50`
                                                }`}
                                            >
                                                {goal.completed && <CheckIcon />}
                                            </button>
                                            
                                            <div className="flex-1 min-w-0">
                                                <div className="text-sm text-gray-800 mb-1">
                                                    {goal.text}
                                                </div>
                                                {goal.category && (
                                                    <span className={`inline-block px-2 py-1 text-xs rounded-full ${
                                                        goal.category === 'spiritual' ? 'bg-blue-100 text-blue-800' :
                                                        goal.category === 'personal' ? 'bg-green-100 text-green-800' :
                                                        goal.category === 'outreach' ? 'bg-purple-100 text-purple-800' :
                                                        goal.category === 'health' ? 'bg-red-100 text-red-800' :
                                                        'bg-gray-100 text-gray-800'
                                                    }`}>
                                                        {goal.category}
                                                    </span>
                                                )}
                                            </div>
                                            
                                            <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button
                                                    onClick={() => startEditing(goal)}
                                                    className="text-blue-600 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50 transition-colors"
                                                    title="Edit goal"
                                                >
                                                    <EditIcon />
                                                </button>
                                                <button
                                                    onClick={() => onRemove(goalType, goal.id)}
                                                    className="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-colors"
                                                    title="Remove goal"
                                                >
                                                    <TrashIcon />
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        <button
                            onClick={() => onAdd(goalType)}
                            className={`w-full py-3 border-2 border-dashed rounded-xl transition-all duration-200 flex items-center justify-center gap-2 font-medium hover:scale-[1.02] ${colors.button}`}
                        >
                            <PlusIcon />
                            Add Goal
                        </button>

                        {goals.length > 0 && (
                            <div className="mt-4 pt-4 border-t border-gray-200">
                                <div className="flex justify-between text-sm text-gray-600 font-medium">
                                    <span>{goals.length} total</span>
                                    <span>{goals.filter(goal => goal.completed).length} completed</span>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DailyDavidApp />, document.getElementById('root'));
    </script>
</body>
</html>
